<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æº«SINTåœ°åœ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    /* å„ªåŒ– Popup æ¨£å¼ */
    .leaflet-popup-content-wrapper {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 4px 16px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(226, 232, 240, 0.8);
      backdrop-filter: blur(10px);
    }
    
    .leaflet-popup-content {
      font-size: 14px;
      line-height: 1.5;
      margin: 16px 20px;
      color: #1e293b;
    }
    
    .leaflet-popup-tip {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .popup-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .popup-icon {
      width: 24px;
      height: 24px;
      margin-right: 10px;
      flex-shrink: 0;
    }
    
    .popup-title {
      font-weight: 600;
      font-size: 16px;
      color: #0f172a;
      margin: 0;
    }
    
    .popup-field {
      margin-bottom: 8px;
      padding: 6px 0;
    }
    
    .popup-field strong {
      color: #475569;
      font-weight: 600;
      display: inline-block;
      min-width: 80px;
    }
    
    .popup-field-value {
      color: #1e293b;
      margin-left: 8px;
    }
    
    .popup-distance {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      padding: 8px 12px;
      border-radius: 8px;
      margin: 8px 0;
      border-left: 4px solid #3b82f6;
    }
    
    .popup-links {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e2e8f0;
    }
    
    .popup-links-title {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .link-btn {
      display: inline-block;
      margin-bottom: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      background: #f3f4f6;
      color: #374151;
      text-decoration: none;
      font-size: 12px;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #d1d5db;
    }
    .link-btn:hover { 
      background: #e5e7eb; 
      color: #1f2937;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-color: #9ca3af;
    }
    
    /* æ§åˆ¶é¢æ¿æ¨£å¼ */
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 1000;
      min-width: 280px;
      max-width: 320px;
    }
    
    .control-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #1f2937;
      font-size: 16px;
    }
    
    .input-group {
      margin-bottom: 12px;
    }
    
    .input-label {
      display: block;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .input-field {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* å„ªåŒ–ä¸‹æ‹‰é¸å–®æ¨£å¼ */
    select.input-field {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px;
    }
    
    select.input-field:hover {
      border-color: #3b82f6;
    }
    
    /* è‡ªå®šç¾©è»äº‹æ¨™è¨˜æ¨£å¼ */
    .custom-military-marker {
      background: none !important;
      border: none !important;
    }
    
    /* é›¶è·é›¢æ¨™è¨˜å‹•ç•«æ•ˆæœ */
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    @keyframes pulseRing {
      0% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }
    
    .zero-distance-marker {
      z-index: 1000 !important;
    }
    
    /* popupä¸­é›¶è·é›¢æ¨™è¨˜çš„å¾®å¦™å‹•ç•« */
    @keyframes subtle-pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.02);
        opacity: 0.95;
      }
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      color: #475569;
      border: 1px solid #cbd5e1;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    
    .info-panel {
      background: #f3f4f6;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      color: #4b5563;
      margin-top: 10px;
    }
    
    /* è¼‰å…¥æŒ‡ç¤ºå™¨ */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 2000;
      text-align: center;
    }
    
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #2563eb;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* éš±è—æ§åˆ¶é¢æ¿çš„æŒ‰éˆ• */
    .toggle-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 1001;
      font-size: 18px;
    }
    
    .control-panel.hidden {
      transform: translateX(-100%);
      opacity: 0;
      pointer-events: none;
    }
    
    /* æ‰‹æ©Ÿç‰ˆéŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .control-panel {
        position: fixed;
        top: 60px;
        left: 10px;
        right: 10px;
        max-width: none;
        min-width: auto;
        transform: translateX(-100%);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
      }
      
      .control-panel.show-mobile {
        transform: translateX(0);
        opacity: 1;
      }
      
      .toggle-panel {
        top: 10px;
        right: 10px;
        font-size: 20px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,0.1);
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .toggle-panel:active {
        transform: scale(0.95);
      }
      
      /* æ‰‹æ©Ÿç‰ˆpopupå„ªåŒ– */
      .leaflet-popup-content-wrapper {
        max-width: calc(100vw - 40px) !important;
        min-width: 280px;
      }
      
      .leaflet-popup-content {
        margin: 12px 16px !important;
        font-size: 13px;
        line-height: 1.4;
      }
      
      .popup-title {
        font-size: 14px;
      }
      
      .popup-icon {
        width: 20px;
        height: 20px;
      }
      
      .popup-field {
        margin-bottom: 6px;
        padding: 4px 0;
      }
      
      .popup-field strong {
        min-width: 70px;
        font-size: 12px;
      }
      
      .popup-field-value {
        font-size: 12px;
      }
      
      .popup-distance {
        padding: 6px 10px;
        margin: 6px 0;
        font-size: 12px;
      }
      
      .link-btn {
        padding: 3px 6px;
        font-size: 11px;
        margin-bottom: 3px;
      }
      
      .popup-links-title {
        font-size: 11px;
        margin-bottom: 6px;
      }
      
      /* æ‰‹æ©Ÿç‰ˆæ§åˆ¶é¢æ¿å…§å®¹å„ªåŒ– */
      .control-title {
        font-size: 15px;
        margin-bottom: 8px;
        position: relative;
      }
      
      .mobile-hint {
        font-size: 10px;
        color: #6b7280;
        background: #f3f4f6;
        padding: 4px 8px;
        border-radius: 6px;
        margin-bottom: 8px;
        text-align: center;
        border: 1px solid #e5e7eb;
      }
      
      .input-label {
        font-size: 11px;
        margin-bottom: 3px;
      }
      
      .input-field {
        padding: 6px 10px;
        font-size: 13px;
      }
      
      .btn {
        padding: 6px 12px;
        font-size: 12px;
        margin-right: 6px;
        margin-bottom: 6px;
      }
      
      .info-panel {
        padding: 6px 10px;
        font-size: 11px;
        margin-top: 8px;
      }
    }
    
    /* æ¥µå°è¢å¹•å„ªåŒ– */
    @media (max-width: 480px) {
      .leaflet-popup-content-wrapper {
        max-width: calc(100vw - 20px) !important;
        min-width: 260px;
      }
      
      .control-panel {
        left: 5px;
        right: 5px;
        top: 55px;
      }
      
      .toggle-panel {
        right: 5px;
        padding: 10px;
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>è¼‰å…¥åœ°åœ–è³‡æ–™ä¸­...</div>
  </div>
  
  <!-- æ§åˆ¶é¢æ¿ -->
  <div id="controlPanel" class="control-panel" onclick="event.stopPropagation();">
    <div class="control-title">ğŸ—ºï¸ åœ°åœ–æ§åˆ¶</div>
    <div id="mobileHint" class="mobile-hint" style="display: none;">
      ğŸ“± é»æ“Šåœ°åœ–ä»»æ„è™•é—œé–‰æ­¤é¢æ¿
    </div>
    
    <div class="input-group">
      <label class="input-label">ç·¯åº¦ (Latitude)</label>
      <input type="number" id="latInput" class="input-field" step="any" placeholder="ä¾‹å¦‚: 31.9424765">
    </div>
    
    <div class="input-group">
      <label class="input-label">ç¶“åº¦ (Longitude)</label>
      <input type="number" id="lngInput" class="input-field" step="any" placeholder="ä¾‹å¦‚: 120.2903877">
    </div>
    
    <div class="input-group">
      <label class="input-label">æœå°‹åŠå¾‘ (å…¬é‡Œ)</label>
      <input type="number" id="radiusInput" class="input-field" value="50" min="1" max="500" step="5">
    </div>
    
    <div class="input-group">
      <label class="input-label">åˆ†å±¤ç¯©é¸</label>
      <select id="layerFilter" class="input-field" onchange="filterByLayer()">
        <option value="">é¡¯ç¤ºå…¨éƒ¨åˆ†å±¤</option>
        <option value="ä¸­åœ‹è»å·¥åŠèˆªå¤©ç”¢æ¥­">ğŸ”§ ä¸­åœ‹è»å·¥åŠèˆªå¤©ç”¢æ¥­</option>
        <option value="æ­¦è£è­¦å¯Ÿã€æµ·å¤–è»äº‹è¨­æ–½åŠå…¶ä»–åˆ†é¡">ğŸ›¡ï¸ æ­¦è£è­¦å¯Ÿã€æµ·å¤–è»äº‹è¨­æ–½</option>
        <option value="è§£æ”¾è»æµ·è»ã€æµ·è»é™¸æˆ°éšŠåŸºåœ°åŠè¨­æ–½">âš“ è§£æ”¾è»æµ·è»ã€æµ·è»é™¸æˆ°éšŠ</option>
        <option value="è§£æ”¾è»ç«ç®­è»">ğŸš€ è§£æ”¾è»ç«ç®­è»</option>
        <option value="è§£æ”¾è»ç©ºè»ã€æµ·è»èˆªç©ºå…µåŸºåœ°åŠè¨­æ–½">âœˆï¸ è§£æ”¾è»ç©ºè»ã€æµ·è»èˆªç©ºå…µ</option>
        <option value="è§£æ”¾è»è»äº‹èˆªå¤©éƒ¨éšŠã€ç¶²è·¯ç©ºé–“éƒ¨éšŠã€ä¿¡æ¯æ”¯æ´éƒ¨éšŠ">ğŸ›°ï¸ è»äº‹èˆªå¤©ã€ç¶²è·¯ç©ºé–“éƒ¨éšŠ</option>
        <option value="è§£æ”¾è»è»äº‹é™¢æ ¡ã€æ•™è‚²å–®ä½">ğŸ“ è§£æ”¾è»è»äº‹é™¢æ ¡ã€æ•™è‚²</option>
        <option value="è§£æ”¾è»é‡è¦è¨“å ´/ç‰¹æ®Šè¨­æ–½">ğŸ¯ è§£æ”¾è»é‡è¦è¨“å ´/ç‰¹æ®Šè¨­æ–½</option>
        <option value="è§£æ”¾è»é™¸è»ã€é™¸è»é˜²ç©ºå–®ä½ã€è¯å‹¤ä¿éšœè¨­æ–½ã€é å‚™å½¹éƒ¨éšŠ(éƒ¨åˆ†è¨­æ–½ç‚ºå€‹äººæ¨æ–·)">ğŸª– è§£æ”¾è»é™¸è»ã€è¯å‹¤ä¿éšœ</option>
        <option value="é»¨å’Œåœ‹å®¶é‡è¦æ”¿ç¶“è»äº‹æ©Ÿé—œ">ğŸ›ï¸ é»¨å’Œåœ‹å®¶é‡è¦æ”¿ç¶“è»äº‹æ©Ÿé—œ</option>
      </select>
    </div>
    
    <button class="btn btn-primary" onclick="searchLocation()">ğŸ” æœå°‹ä½ç½®</button>
    <button class="btn btn-secondary" onclick="showAllLocations()">ğŸŒ é¡¯ç¤ºå…¨éƒ¨</button>
    <button class="btn btn-secondary" onclick="copyUrl()">ğŸ“‹ è¤‡è£½é€£çµ</button>
    
    <div id="infoPanel" class="info-panel" style="display: none;">
      <div id="infoText"></div>
    </div>
  </div>
  
  <!-- éš±è—é¢æ¿æŒ‰éˆ• -->
  <button class="toggle-panel" onclick="togglePanel()">âš™ï¸</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // è§£æURLåƒæ•¸ - ç²å–ç¶“ç·¯åº¦
    function parseUrlCoordinates() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // æ”¯æ´å¤šç¨®åƒæ•¸æ ¼å¼
      // æ ¼å¼1: ?lat=31.9424765&lng=120.2903877
      if (urlParams.has('lat') && urlParams.has('lng')) {
        return {
          lat: parseFloat(urlParams.get('lat')),
          lng: parseFloat(urlParams.get('lng'))
        };
      }
      
      // æ ¼å¼2: ?coords=31.9424765,120.2903877
      if (urlParams.has('coords')) {
        const coords = urlParams.get('coords').split(',');
        if (coords.length === 2) {
          return {
            lat: parseFloat(coords[0]),
            lng: parseFloat(coords[1])
          };
        }
      }
      
      // æ ¼å¼3: è·¯å¾‘æ ¼å¼ /31.9424765,120.2903877 (å‘å¾Œç›¸å®¹)
      const path = window.location.pathname;
      const coordinatePattern = /\/(-?\d+\.?\d*),(-?\d+\.?\d*)$/;
      const match = path.match(coordinatePattern);
      
      if (match) {
        return {
          lat: parseFloat(match[1]),
          lng: parseFloat(match[2])
        };
      }
      
      return null;
    }

    // è¨ˆç®—å…©é»é–“è·é›¢(å…¬é‡Œ) - ä½¿ç”¨Haversineå…¬å¼
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // åœ°çƒåŠå¾‘(å…¬é‡Œ)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // åˆå§‹åŒ–åœ°åœ–
    function initializeMap() {
      map = L.map('map', { 
        zoomControl: false,
        maxZoom: 22, // å¢åŠ æœ€å¤§ç¸®æ”¾ç´šåˆ¥ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥çœ‹å¾—æ›´æ¸…æ¥š
        minZoom: 2,
        tap: true, // æ‰‹æ©Ÿç‰ˆé»æ“Šæ”¯æ´
        tapTolerance: 15 // å¢åŠ é»æ“Šå®¹å·®
      }).setView([31.9424765, 120.2903877], 7);
      
      // æ ¹æ“šè¨­å‚™é¡å‹èª¿æ•´ç¸®æ”¾æ§åˆ¶å™¨ä½ç½®
      if (isMobileDevice()) {
        L.control.zoom({ position: 'bottomright' }).addTo(map);
      } else {
    L.control.zoom({ position: 'topright' }).addTo(map);
      }

      // ä½¿ç”¨é«˜è§£æåº¦è¡›æ˜Ÿåœ–å±¤
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 22 // æ”¯æ´é«˜ç¸®æ”¾ç´šåˆ¥
    }).addTo(map);

      // æ‰‹æ©Ÿç‰ˆï¼šé»æ“Šåœ°åœ–é—œé–‰æ§åˆ¶é¢æ¿
      if (isMobileDevice()) {
        map.on('click', function() {
          const panel = document.getElementById('controlPanel');
          if (panel.classList.contains('show-mobile')) {
            panel.classList.remove('show-mobile');
          }
        });
      }
    }

    // SVGåœ–æ¨™ç³»çµ±
    const layerIcons = {
      'ä¸­åœ‹è»å·¥åŠèˆªå¤©ç”¢æ¥­': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#4338ca" stroke="#312e81" stroke-width="2"/>
          <path d="M12 6v12M8 8l8 8M8 16l8-8" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="12" r="2" fill="white"/>
        </svg>`,
        color: '#4338ca'
      },
      'æ­¦è£è­¦å¯Ÿã€æµ·å¤–è»äº‹è¨­æ–½åŠå…¶ä»–åˆ†é¡': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="6" width="18" height="12" rx="2" fill="#dc2626" stroke="#991b1b" stroke-width="2"/>
          <path d="M9 10h6M9 14h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <circle cx="7" cy="12" r="1" fill="white"/>
          <circle cx="17" cy="12" r="1" fill="white"/>
        </svg>`,
        color: '#dc2626'
      },
      'è§£æ”¾è»æµ·è»ã€æµ·è»é™¸æˆ°éšŠåŸºåœ°åŠè¨­æ–½': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#0369a1" stroke="#075985" stroke-width="2"/>
          <path d="M6 12h12M12 6v12" stroke="white" stroke-width="2"/>
          <path d="M8 8l8 8M16 8l-8 8" stroke="white" stroke-width="1" opacity="0.7"/>
          <circle cx="12" cy="12" r="3" fill="none" stroke="white" stroke-width="1"/>
        </svg>`,
        color: '#0369a1'
      },
      'è§£æ”¾è»ç«ç®­è»': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#b91c1c" stroke="#7f1d1d" stroke-width="2"/>
          <path d="M12 4l2 4h-4l2-4zM12 4v16" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 10l8 0M8 14l8 0" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M10 18l4 0" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>`,
        color: '#b91c1c'
      },
      'è§£æ”¾è»ç©ºè»ã€æµ·è»èˆªç©ºå…µåŸºåœ°åŠè¨­æ–½': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#059669" stroke="#047857" stroke-width="2"/>
          <path d="M12 6l4 8h-8l4-8z" fill="white"/>
          <path d="M6 12h4M14 12h4" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="16" r="1" fill="white"/>
        </svg>`,
        color: '#059669'
      },
      'è§£æ”¾è»è»äº‹èˆªå¤©éƒ¨éšŠã€ç¶²è·¯ç©ºé–“éƒ¨éšŠã€ä¿¡æ¯æ”¯æ´éƒ¨éšŠ': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#7c3aed" stroke="#5b21b6" stroke-width="2"/>
          <circle cx="12" cy="8" r="2" fill="white"/>
          <path d="M12 10v4M10 14h4" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 16l8-8M16 16l-8-8" stroke="white" stroke-width="1" opacity="0.7"/>
        </svg>`,
        color: '#7c3aed'
      },
      'è§£æ”¾è»è»äº‹é™¢æ ¡ã€æ•™è‚²å–®ä½': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#ea580c" stroke="#c2410c" stroke-width="2"/>
          <rect x="8" y="8" width="8" height="6" rx="1" fill="white"/>
          <path d="M10 11h4M10 13h4" stroke="#ea580c" stroke-width="1" stroke-linecap="round"/>
          <path d="M12 8V6" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>`,
        color: '#ea580c'
      },
      'è§£æ”¾è»é‡è¦è¨“å ´/ç‰¹æ®Šè¨­æ–½': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#0d9488" stroke="#0f766e" stroke-width="2"/>
          <path d="M8 8h8l-2 2H10l-2-2zM8 16h8l-2-2H10l-2 2z" fill="white"/>
          <path d="M12 6v12" stroke="white" stroke-width="2"/>
          <circle cx="12" cy="12" r="1.5" fill="white"/>
        </svg>`,
        color: '#0d9488'
      },
      'è§£æ”¾è»é™¸è»ã€é™¸è»é˜²ç©ºå–®ä½ã€è¯å‹¤ä¿éšœè¨­æ–½ã€é å‚™å½¹éƒ¨éšŠ(éƒ¨åˆ†è¨­æ–½ç‚ºå€‹äººæ¨æ–·)': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#16a34a" stroke="#15803d" stroke-width="2"/>
          <rect x="9" y="9" width="6" height="6" rx="1" fill="white"/>
          <path d="M11 11h2M11 13h2" stroke="#16a34a" stroke-width="1"/>
          <path d="M6 12h3M15 12h3M12 6v3M12 15v3" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
        </svg>`,
        color: '#16a34a'
      },
      'é»¨å’Œåœ‹å®¶é‡è¦æ”¿ç¶“è»äº‹æ©Ÿé—œ': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#be123c" stroke="#9f1239" stroke-width="2"/>
          <path d="M8 10l4-2 4 2v6l-4 2-4-2v-6z" fill="white"/>
          <path d="M12 8v8M8 10l4 4 4-4" stroke="#be123c" stroke-width="1"/>
          <circle cx="12" cy="6" r="1" fill="white"/>
        </svg>`,
        color: '#be123c'
      }
    };

    // æ ¹æ“šlayerç²å–åœ–æ¨™
    function getLayerIcon(layerName) {
      return layerIcons[layerName] || layerIcons['æ­¦è£è­¦å¯Ÿã€æµ·å¤–è»äº‹è¨­æ–½åŠå…¶ä»–åˆ†é¡'];
    }

    // å‰µå»ºè‡ªå®šç¾©æ¨™è¨˜åœ–æ¨™
    function createCustomIcon(layerName, isZeroDistance = false) {
      const iconData = getLayerIcon(layerName);
      const size = isZeroDistance ? 40 : 32; // é›¶è·é›¢æ¨™è¨˜ç¨å¤§ä¸€é»
      
      return L.divIcon({
        className: `custom-military-marker ${isZeroDistance ? 'zero-distance-marker' : ''}`,
        html: `
          <div style="
            width: ${size}px; 
            height: ${size}px; 
            position: relative;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            ${isZeroDistance ? `
              animation: pulseRing 2s infinite;
              border: 3px solid #ef4444;
              border-radius: 50%;
              background: rgba(239, 68, 68, 0.1);
              backdrop-filter: blur(4px);
            ` : ''}
          ">
            ${iconData.svg}
            ${isZeroDistance ? `
              <div style="
                position: absolute;
                top: -3px;
                right: -3px;
                width: 12px;
                height: 12px;
                background: #ef4444;
                border: 2px solid white;
                border-radius: 50%;
                animation: pulse 1.5s infinite;
                box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3);
              "></div>
            ` : ''}
          </div>
        `,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
        popupAnchor: [0, -size/2]
      });
    }

    // å–å¾—æ¨™ç±¤åç¨±
    function getLabel(url) {
      url = url.toLowerCase();
      return url.includes('twitter.com') || url.includes('x.com') ? 'Twitter/X' :
             url.includes('wikipedia.org') ? 'Wikipedia' :
             url.includes('weixin.qq.com') ? 'å¾®ä¿¡å…¬çœ¾è™Ÿ' :
             url.includes('youtube.com') ? 'YouTube' :
             url.includes('thepaper.cn') ? 'æ¾æ¹ƒæ–°è' :
             url.includes('cctv.com') ? 'CCTV' :
             url.includes('bilibili.com') ? 'Bilibili' :
             'ç›¸é—œé€£çµ';
    }
    
    // ä¸»è¦åˆå§‹åŒ–å‡½æ•¸
    async function init() {
      showLoading();
      
      try {
        // åˆå§‹åŒ–åœ°åœ–
        initializeMap();
        
        // åˆå§‹åŒ–é¢æ¿ç‹€æ…‹ï¼ˆæ‰‹æ©Ÿç‰ˆé è¨­éš±è—ï¼‰
        initializePanelState();
        
        // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
        window.addEventListener('resize', handleResize);
        
        // è§£æURLåƒæ•¸
        const urlCoords = parseUrlCoordinates();
        const urlParams = new URLSearchParams(window.location.search);
        const radius = parseFloat(urlParams.get('radius')) || 50;
        const selectedLayer = urlParams.get('layer') || '';
        
        // å¦‚æœæœ‰URLåƒæ•¸ï¼Œå¡«å…¥æ§åˆ¶é¢æ¿
        if (urlCoords) {
          document.getElementById('latInput').value = urlCoords.lat;
          document.getElementById('lngInput').value = urlCoords.lng;
        }
        document.getElementById('radiusInput').value = radius;
        document.getElementById('layerFilter').value = selectedLayer;
        
        // è¼‰å…¥åœ°åœ–è³‡æ–™
        const geojsonURL = 'https://terryuuang.github.io/my-json-cdn/joseph_w-20250806.geojson';
        const response = await fetch(geojsonURL);
        
        if (!response.ok) {
          throw new Error(`è¼‰å…¥è³‡æ–™å¤±æ•—: ${response.status}`);
        }
        
        const data = await response.json();
        allFeatures = data.features;
        
        // æ ¹æ“šURLåƒæ•¸æ¸²æŸ“åœ°åœ–
        renderMap(urlCoords, radius, selectedLayer);
        
        hideLoading();
        
      } catch (error) {
        hideLoading();
        console.error('è¼‰å…¥åœ°åœ–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        updateInfoPanel(`éŒ¯èª¤ï¼š${error.message}`);
        
        // å³ä½¿è¼‰å…¥å¤±æ•—ä¹Ÿè¦åˆå§‹åŒ–åŸºæœ¬åœ°åœ–
        if (!map) {
          initializeMap();
        }
      }
    }

    // å…¨åŸŸè®Šæ•¸
    let map;
    let allFeatures = [];
    let currentMarkers = L.layerGroup();
    let centerMarker = null;

    // ç¯©é¸åŠŸèƒ½ - æ ¹æ“šè·é›¢ç¯©é¸é»ä½
    function filterFeaturesByDistance(features, centerLat, centerLng, radiusKm = 50) {
      return features.filter(feature => {
        const coords = feature.geometry.coordinates;
        const distance = calculateDistance(centerLat, centerLng, coords[1], coords[0]);
        return distance <= radiusKm;
      });
    }

    // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }
    
    // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    
    // æ›´æ–°è³‡è¨Šé¢æ¿
    function updateInfoPanel(message) {
      const infoPanel = document.getElementById('infoPanel');
      const infoText = document.getElementById('infoText');
      infoText.textContent = message;
      infoPanel.style.display = 'block';
    }
    
    // æª¢æ¸¬æ˜¯å¦ç‚ºæ‰‹æ©Ÿè¨­å‚™
    function isMobileDevice() {
      return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // éš±è—/é¡¯ç¤ºæ§åˆ¶é¢æ¿
    function togglePanel() {
      const panel = document.getElementById('controlPanel');
      
      if (isMobileDevice()) {
        // æ‰‹æ©Ÿç‰ˆä½¿ç”¨ä¸åŒçš„class
        panel.classList.toggle('show-mobile');
      } else {
        // æ¡Œé¢ç‰ˆä½¿ç”¨åŸæœ‰çš„hidden class
        panel.classList.toggle('hidden');
      }
    }
    
    // åˆå§‹åŒ–é¢æ¿é¡¯ç¤ºç‹€æ…‹
    function initializePanelState() {
      const panel = document.getElementById('controlPanel');
      const mobileHint = document.getElementById('mobileHint');
      
      if (isMobileDevice()) {
        // æ‰‹æ©Ÿç‰ˆé è¨­éš±è—
        panel.classList.remove('show-mobile');
        // ç¢ºä¿ä¸ä½¿ç”¨æ¡Œé¢ç‰ˆçš„hidden class
        panel.classList.remove('hidden');
        // é¡¯ç¤ºæ‰‹æ©Ÿç‰ˆæç¤º
        mobileHint.style.display = 'block';
      } else {
        // æ¡Œé¢ç‰ˆé è¨­é¡¯ç¤º
        panel.classList.remove('hidden');
        panel.classList.remove('show-mobile');
        // éš±è—æ‰‹æ©Ÿç‰ˆæç¤º
        mobileHint.style.display = 'none';
      }
    }
    
    // ç›£è½è¦–çª—å¤§å°è®ŠåŒ–
    function handleResize() {
      const panel = document.getElementById('controlPanel');
      const mobileHint = document.getElementById('mobileHint');
      
      if (isMobileDevice()) {
        // åˆ‡æ›åˆ°æ‰‹æ©Ÿç‰ˆ
        panel.classList.remove('hidden');
        mobileHint.style.display = 'block';
        if (!panel.classList.contains('show-mobile')) {
          // å¦‚æœé¢æ¿æ˜¯é–‹å•Ÿç‹€æ…‹ï¼Œä¿æŒé–‹å•Ÿ
          const wasVisible = !panel.classList.contains('hidden');
          if (wasVisible) {
            panel.classList.add('show-mobile');
          }
        }
      } else {
        // åˆ‡æ›åˆ°æ¡Œé¢ç‰ˆ
        panel.classList.remove('show-mobile');
        mobileHint.style.display = 'none';
        // æ¡Œé¢ç‰ˆé è¨­é¡¯ç¤º
        panel.classList.remove('hidden');
      }
    }
    
    // æ ¹æ“šåˆ†å±¤ç¯©é¸ç‰¹å¾µ
    function filterFeaturesByLayer(features, selectedLayer) {
      if (!selectedLayer) return features;
      
      return features.filter(feature => {
        const props = feature.properties || {};
        const layerName = props.layer || props['åˆ†å±¤'] || props['é¡åˆ¥'] || 'æ­¦è£è­¦å¯Ÿã€æµ·å¤–è»äº‹è¨­æ–½åŠå…¶ä»–åˆ†é¡';
        return layerName === selectedLayer;
      });
    }
    
    // åˆ†å±¤ç¯©é¸åŠŸèƒ½
    function filterByLayer() {
      const selectedLayer = document.getElementById('layerFilter').value;
      const urlCoords = parseUrlCoordinates();
      const urlParams = new URLSearchParams(window.location.search);
      const radius = parseFloat(urlParams.get('radius')) || 50;
      
      // æ›´æ–°URLåƒæ•¸
      if (selectedLayer) {
        urlParams.set('layer', selectedLayer);
      } else {
        urlParams.delete('layer');
      }
      
      const newUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;
      window.history.pushState({}, '', newUrl);
      
      // é‡æ–°æ¸²æŸ“åœ°åœ–
      renderMap(urlCoords, radius, selectedLayer);
    }
    
    // æœå°‹ä½ç½®åŠŸèƒ½
    function searchLocation() {
      const lat = parseFloat(document.getElementById('latInput').value);
      const lng = parseFloat(document.getElementById('lngInput').value);
      const radius = parseFloat(document.getElementById('radiusInput').value) || 50;
      const selectedLayer = document.getElementById('layerFilter').value;
      
      if (isNaN(lat) || isNaN(lng)) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶“ç·¯åº¦æ•¸å€¼ï¼');
        return;
      }
      
      // æ›´æ–°URL
      const urlParams = new URLSearchParams();
      urlParams.set('lat', lat);
      urlParams.set('lng', lng);
      urlParams.set('radius', radius);
      if (selectedLayer) {
        urlParams.set('layer', selectedLayer);
      }
      
      const newUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;
      window.history.pushState({}, '', newUrl);
      
      // é‡æ–°æ¸²æŸ“åœ°åœ–
      renderMap({ lat, lng }, radius, selectedLayer);
    }
    
    // é¡¯ç¤ºå…¨éƒ¨ä½ç½®
    function showAllLocations() {
      // æ¸…é™¤URLåƒæ•¸
      const newUrl = `${window.location.origin}${window.location.pathname}`;
      window.history.pushState({}, '', newUrl);
      
      // æ¸…ç©ºè¼¸å…¥æ¬„
      document.getElementById('latInput').value = '';
      document.getElementById('lngInput').value = '';
      document.getElementById('radiusInput').value = '50';
      document.getElementById('layerFilter').value = '';
      
      // é‡æ–°æ¸²æŸ“åœ°åœ–
      renderMap(null);
    }
    
    // è¤‡è£½URLåŠŸèƒ½
    function copyUrl() {
      const url = window.location.href;
      navigator.clipboard.writeText(url).then(() => {
        updateInfoPanel('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        setTimeout(() => {
          document.getElementById('infoPanel').style.display = 'none';
        }, 3000);
      }).catch(() => {
        // å‚™ç”¨æ–¹æ¡ˆ
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        updateInfoPanel('é€£çµå·²è¤‡è£½ï¼');
        setTimeout(() => {
          document.getElementById('infoPanel').style.display = 'none';
        }, 3000);
      });
    }
    
    // æ¸²æŸ“åœ°åœ–åŠŸèƒ½
    function renderMap(targetCoords, radiusKm = 50, selectedLayer = null) {
      // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
      currentMarkers.clearLayers();
      if (centerMarker) {
        map.removeLayer(centerMarker);
        centerMarker = null;
      }
      
      let featuresToShow = allFeatures;
      let mapCenter = [31.9424765, 120.2903877]; // é è¨­ä¸­å¿ƒ
      let mapZoom = 7;
      
      // å…ˆé€²è¡Œåˆ†å±¤ç¯©é¸
      if (selectedLayer) {
        featuresToShow = filterFeaturesByLayer(featuresToShow, selectedLayer);
      }
      
      // ç„¶å¾Œé€²è¡Œåœ°ç†ä½ç½®ç¯©é¸
      if (targetCoords) {
        mapCenter = [targetCoords.lat, targetCoords.lng];
        mapZoom = 15; // å¢åŠ é è¨­ç¸®æ”¾ç´šåˆ¥ï¼Œè®“ç”¨æˆ¶èƒ½çœ‹å¾—æ›´æ¸…æ¥š
        
        // ç¯©é¸é™„è¿‘çš„é»ä½
          featuresToShow = filterFeaturesByDistance(
          featuresToShow, 
          targetCoords.lat, 
          targetCoords.lng, 
          radiusKm
        );
        
        // æ·»åŠ ä¸­å¿ƒæ¨™è¨˜
          const redIcon = L.divIcon({
            className: 'custom-red-marker',
          html: '<div style="background-color: #ef4444; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          });
          
        centerMarker = L.marker([targetCoords.lat, targetCoords.lng], { icon: redIcon })
           .addTo(map)
          .bindPopup(`<strong>ğŸ¯ æœå°‹ä¸­å¿ƒ</strong><br/>ç·¯åº¦: ${targetCoords.lat}<br/>ç¶“åº¦: ${targetCoords.lng}<br/>æœå°‹åŠå¾‘: ${radiusKm} å…¬é‡Œ`);
        }
      
      // è¨­å®šåœ°åœ–è¦–é‡
      map.setView(mapCenter, mapZoom);

        // é¡¯ç¤ºç¯©é¸å¾Œçš„é»ä½
        L.geoJSON({ type: 'FeatureCollection', features: featuresToShow }, {
        pointToLayer: (feature, latlng) => {
          const props = feature.properties || {};
          const layerName = props.layer || props['åˆ†å±¤'] || props['é¡åˆ¥'] || 'æ­¦è£è­¦å¯Ÿã€æµ·å¤–è»äº‹è¨­æ–½åŠå…¶ä»–åˆ†é¡';
          
          // æª¢æŸ¥æ˜¯å¦ç‚ºé›¶è·é›¢é»ä½ï¼ˆè·é›¢æœå°‹ä¸­å¿ƒå¾ˆè¿‘ï¼‰
          let isZeroDistance = false;
          if (targetCoords) {
            const coords = feature.geometry.coordinates;
            const distance = calculateDistance(targetCoords.lat, targetCoords.lng, coords[1], coords[0]);
            isZeroDistance = distance < 0.1; // å°æ–¼100å…¬å°ºè¦–ç‚ºé›¶è·é›¢
          }
          
          const customIcon = createCustomIcon(layerName, isZeroDistance);
          const marker = L.marker(latlng, { icon: customIcon });
          currentMarkers.addLayer(marker);
          return marker;
        },
          onEachFeature: (feature, layer) => {
            const props = feature.properties || {};
          const layerName = props.layer || props['åˆ†å±¤'] || props['é¡åˆ¥'] || 'æ­¦è£è­¦å¯Ÿã€æµ·å¤–è»äº‹è¨­æ–½åŠå…¶ä»–åˆ†é¡';
          const iconData = getLayerIcon(layerName);
          
            let popupContent = '';
            let referenceLinks = [];
          let mainTitle = props['åç¨±'] || props['name'] || 'è»äº‹è¨­æ–½';

          // æ§‹å»ºpopupæ¨™é¡Œ
          popupContent += `
            <div class="popup-header">
              <div class="popup-icon">${iconData.svg}</div>
              <h3 class="popup-title">${mainTitle}</h3>
            </div>
          `;

          // é¡¯ç¤ºåˆ†å±¤è³‡è¨Š
          popupContent += `
            <div class="popup-field">
              <strong>åˆ†å±¤é¡åˆ¥:</strong>
              <span class="popup-field-value" style="color: ${iconData.color}; font-weight: 600;">${layerName}</span>
            </div>
          `;

          // è™•ç†å…¶ä»–å±¬æ€§
            Object.entries(props).forEach(([key, value]) => {
              if (key === 'èªªæ˜') {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const matchedURLs = value.match(urlRegex);
                if (matchedURLs) {
                  referenceLinks.push(...matchedURLs);
                  value = value.replace(urlRegex, '').trim();
                }
              }
            
            // è·³éå·²è™•ç†çš„æ¬„ä½
            if (['åç¨±', 'name', 'layer', 'åˆ†å±¤', 'é¡åˆ¥'].includes(key)) return;
            
            if (value && value.toString().trim()) {
              popupContent += `
                <div class="popup-field">
                  <strong>${key}:</strong>
                  <span class="popup-field-value">${value}</span>
                </div>
              `;
            }
          });

          // å¦‚æœæœ‰ç›®æ¨™åº§æ¨™ï¼Œé¡¯ç¤ºè·é›¢è³‡è¨Š
          if (targetCoords) {
              const coords = feature.geometry.coordinates;
            const distance = calculateDistance(targetCoords.lat, targetCoords.lng, coords[1], coords[0]);
            const isZeroDistance = distance < 0.1;
            
            if (isZeroDistance) {
              popupContent += `
                <div class="popup-distance" style="
                  background: linear-gradient(135deg, #fef2f2, #fee2e2);
                  border-left: 4px solid #ef4444;
                  border: 2px solid #ef4444;
                  animation: subtle-pulse 2s infinite;
                ">
                  <strong>ğŸ¯ å°±åœ¨æœå°‹ä¸­å¿ƒ!</strong> 
                  <span style="color: #ef4444; font-weight: 700;">
                    ${distance < 0.01 ? '< 10å…¬å°º' : `${(distance * 1000).toFixed(0)}å…¬å°º`}
                  </span>
                  <br/>
                  <small style="color: #dc2626;">é€™å€‹è¨­æ–½å°±åœ¨æ‚¨æŒ‡å®šçš„ä½ç½®é™„è¿‘</small>
                </div>
              `;
            } else {
              popupContent += `
                <div class="popup-distance">
                  <strong>ğŸ“ è·é›¢æœå°‹ä¸­å¿ƒ:</strong> ${distance.toFixed(2)} å…¬é‡Œ
                </div>
              `;
            }
          }

          // æ·»åŠ åƒè€ƒé€£çµ
            if (referenceLinks.length) {
            popupContent += `
              <div class="popup-links">
                <div class="popup-links-title">ç›¸é—œé€£çµ</div>
            `;
              referenceLinks.forEach(url => {
                popupContent += `<a class="link-btn" href="${url}" target="_blank">${getLabel(url)}</a><br/>`;
              });
            popupContent += '</div>';
          }

          // æ ¹æ“šè¨­å‚™é¡å‹èª¿æ•´popupè¨­å®š
          const popupOptions = {
            className: 'custom-popup'
          };
          
          if (isMobileDevice()) {
            popupOptions.maxWidth = Math.min(350, window.innerWidth - 40);
            popupOptions.minWidth = Math.min(260, window.innerWidth - 60);
            popupOptions.autoPan = true;
            popupOptions.autoPanPadding = [10, 10];
            popupOptions.closeButton = true;
          } else {
            popupOptions.maxWidth = 350;
            popupOptions.minWidth = 280;
          }
          
          layer.bindPopup(popupContent, popupOptions);
          }
        }).addTo(map);

      // å°‡æ¨™è¨˜ç¾¤çµ„æ·»åŠ åˆ°åœ°åœ–
      currentMarkers.addTo(map);
      
      // æ›´æ–°è³‡è¨Šé¢æ¿
      let message = `é¡¯ç¤º ${featuresToShow.length} å€‹é»ä½`;
      
      if (selectedLayer) {
        message += ` (${selectedLayer})`;
      }
      
      if (targetCoords) {
        message += ` (${radiusKm}å…¬é‡Œå…§)`;
      }
      
      updateInfoPanel(message);
    }

    // ç•¶é é¢è¼‰å…¥å®Œæˆæ™‚å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
