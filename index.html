<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æº«ç´„ç‘Ÿåœ°åœ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .leaflet-popup-content { font-size: 14px; line-height: 1.4; }
    .link-btn {
      display: inline-block;
      margin-bottom: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      background: #2563eb;
      color: #fff;
      text-decoration: none;
      font-size: 12px;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .link-btn:hover { 
      background: #1d4ed8; 
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    
    /* æ§åˆ¶é¢æ¿æ¨£å¼ */
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 1000;
      min-width: 280px;
      max-width: 320px;
    }
    
    .control-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #1f2937;
      font-size: 16px;
    }
    
    .input-group {
      margin-bottom: 12px;
    }
    
    .input-label {
      display: block;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .input-field {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    .btn-primary {
      background: #2563eb;
      color: white;
    }
    
    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }
    
    .btn-secondary:hover {
      background: #d1d5db;
    }
    
    .info-panel {
      background: #f3f4f6;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      color: #4b5563;
      margin-top: 10px;
    }
    
    /* è¼‰å…¥æŒ‡ç¤ºå™¨ */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 2000;
      text-align: center;
    }
    
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #2563eb;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* éš±è—æ§åˆ¶é¢æ¿çš„æŒ‰éˆ• */
    .toggle-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 1001;
      font-size: 18px;
    }
    
    .control-panel.hidden {
      transform: translateX(-100%);
      opacity: 0;
      pointer-events: none;
    }
    
    @media (max-width: 768px) {
      .control-panel {
        position: fixed;
        top: 60px;
        left: 10px;
        right: 10px;
        max-width: none;
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>è¼‰å…¥åœ°åœ–è³‡æ–™ä¸­...</div>
  </div>
  
  <!-- æ§åˆ¶é¢æ¿ -->
  <div id="controlPanel" class="control-panel">
    <div class="control-title">ğŸ—ºï¸ åœ°åœ–æ§åˆ¶</div>
    
    <div class="input-group">
      <label class="input-label">ç·¯åº¦ (Latitude)</label>
      <input type="number" id="latInput" class="input-field" step="any" placeholder="ä¾‹å¦‚: 31.9424765">
    </div>
    
    <div class="input-group">
      <label class="input-label">ç¶“åº¦ (Longitude)</label>
      <input type="number" id="lngInput" class="input-field" step="any" placeholder="ä¾‹å¦‚: 120.2903877">
    </div>
    
    <div class="input-group">
      <label class="input-label">æœå°‹åŠå¾‘ (å…¬é‡Œ)</label>
      <input type="number" id="radiusInput" class="input-field" value="50" min="1" max="500" step="5">
    </div>
    
    <button class="btn btn-primary" onclick="searchLocation()">ğŸ” æœå°‹ä½ç½®</button>
    <button class="btn btn-secondary" onclick="showAllLocations()">ğŸŒ é¡¯ç¤ºå…¨éƒ¨</button>
    <button class="btn btn-secondary" onclick="copyUrl()">ğŸ“‹ è¤‡è£½é€£çµ</button>
    
    <div id="infoPanel" class="info-panel" style="display: none;">
      <div id="infoText"></div>
    </div>
  </div>
  
  <!-- éš±è—é¢æ¿æŒ‰éˆ• -->
  <button class="toggle-panel" onclick="togglePanel()">âš™ï¸</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // è§£æURLåƒæ•¸ - ç²å–ç¶“ç·¯åº¦
    function parseUrlCoordinates() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // æ”¯æ´å¤šç¨®åƒæ•¸æ ¼å¼
      // æ ¼å¼1: ?lat=31.9424765&lng=120.2903877
      if (urlParams.has('lat') && urlParams.has('lng')) {
        return {
          lat: parseFloat(urlParams.get('lat')),
          lng: parseFloat(urlParams.get('lng'))
        };
      }
      
      // æ ¼å¼2: ?coords=31.9424765,120.2903877
      if (urlParams.has('coords')) {
        const coords = urlParams.get('coords').split(',');
        if (coords.length === 2) {
          return {
            lat: parseFloat(coords[0]),
            lng: parseFloat(coords[1])
          };
        }
      }
      
      // æ ¼å¼3: è·¯å¾‘æ ¼å¼ /31.9424765,120.2903877 (å‘å¾Œç›¸å®¹)
      const path = window.location.pathname;
      const coordinatePattern = /\/(-?\d+\.?\d*),(-?\d+\.?\d*)$/;
      const match = path.match(coordinatePattern);
      
      if (match) {
        return {
          lat: parseFloat(match[1]),
          lng: parseFloat(match[2])
        };
      }
      
      return null;
    }

    // è¨ˆç®—å…©é»é–“è·é›¢(å…¬é‡Œ) - ä½¿ç”¨Haversineå…¬å¼
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // åœ°çƒåŠå¾‘(å…¬é‡Œ)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // åˆå§‹åŒ–åœ°åœ–
    function initializeMap() {
      map = L.map('map', { zoomControl: false }).setView([31.9424765, 120.2903877], 7);
      L.control.zoom({ position: 'topright' }).addTo(map);

      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    }

    // å–å¾—æ¨™ç±¤åç¨±
    function getLabel(url) {
      url = url.toLowerCase();
      return url.includes('twitter.com') || url.includes('x.com') ? 'Twitter/X' :
             url.includes('wikipedia.org') ? 'Wikipedia' :
             url.includes('weixin.qq.com') ? 'å¾®ä¿¡å…¬çœ¾è™Ÿ' :
             url.includes('youtube.com') ? 'YouTube' :
             url.includes('thepaper.cn') ? 'æ¾æ¹ƒæ–°è' :
             url.includes('cctv.com') ? 'CCTV' :
             url.includes('bilibili.com') ? 'Bilibili' :
             'ç›¸é—œé€£çµ';
    }
    
    // ä¸»è¦åˆå§‹åŒ–å‡½æ•¸
    async function init() {
      showLoading();
      
      try {
        // åˆå§‹åŒ–åœ°åœ–
        initializeMap();
        
        // è§£æURLåƒæ•¸
        const urlCoords = parseUrlCoordinates();
        const urlParams = new URLSearchParams(window.location.search);
        const radius = parseFloat(urlParams.get('radius')) || 50;
        
        // å¦‚æœæœ‰URLåƒæ•¸ï¼Œå¡«å…¥æ§åˆ¶é¢æ¿
        if (urlCoords) {
          document.getElementById('latInput').value = urlCoords.lat;
          document.getElementById('lngInput').value = urlCoords.lng;
          document.getElementById('radiusInput').value = radius;
        }
        
        // è¼‰å…¥åœ°åœ–è³‡æ–™
        const geojsonURL = 'https://terryuuang.github.io/my-json-cdn/joseph_w-20250806.geojson';
        const response = await fetch(geojsonURL);
        
        if (!response.ok) {
          throw new Error(`è¼‰å…¥è³‡æ–™å¤±æ•—: ${response.status}`);
        }
        
        const data = await response.json();
        allFeatures = data.features;
        
        // æ ¹æ“šURLåƒæ•¸æ¸²æŸ“åœ°åœ–
        renderMap(urlCoords, radius);
        
        hideLoading();
        
      } catch (error) {
        hideLoading();
        console.error('è¼‰å…¥åœ°åœ–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        updateInfoPanel(`éŒ¯èª¤ï¼š${error.message}`);
        
        // å³ä½¿è¼‰å…¥å¤±æ•—ä¹Ÿè¦åˆå§‹åŒ–åŸºæœ¬åœ°åœ–
        if (!map) {
          initializeMap();
        }
      }
    }

    // å…¨åŸŸè®Šæ•¸
    let map;
    let allFeatures = [];
    let currentMarkers = L.layerGroup();
    let centerMarker = null;
    
    // ç¯©é¸åŠŸèƒ½ - æ ¹æ“šè·é›¢ç¯©é¸é»ä½
    function filterFeaturesByDistance(features, centerLat, centerLng, radiusKm = 50) {
      return features.filter(feature => {
        const coords = feature.geometry.coordinates;
        const distance = calculateDistance(centerLat, centerLng, coords[1], coords[0]);
        return distance <= radiusKm;
      });
    }
    
    // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }
    
    // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    
    // æ›´æ–°è³‡è¨Šé¢æ¿
    function updateInfoPanel(message) {
      const infoPanel = document.getElementById('infoPanel');
      const infoText = document.getElementById('infoText');
      infoText.textContent = message;
      infoPanel.style.display = 'block';
    }
    
    // éš±è—/é¡¯ç¤ºæ§åˆ¶é¢æ¿
    function togglePanel() {
      const panel = document.getElementById('controlPanel');
      panel.classList.toggle('hidden');
    }
    
    // æœå°‹ä½ç½®åŠŸèƒ½
    function searchLocation() {
      const lat = parseFloat(document.getElementById('latInput').value);
      const lng = parseFloat(document.getElementById('lngInput').value);
      const radius = parseFloat(document.getElementById('radiusInput').value) || 50;
      
      if (isNaN(lat) || isNaN(lng)) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¶“ç·¯åº¦æ•¸å€¼ï¼');
        return;
      }
      
      // æ›´æ–°URL
      const newUrl = `${window.location.origin}${window.location.pathname}?lat=${lat}&lng=${lng}&radius=${radius}`;
      window.history.pushState({}, '', newUrl);
      
      // é‡æ–°æ¸²æŸ“åœ°åœ–
      renderMap({ lat, lng }, radius);
    }
    
    // é¡¯ç¤ºå…¨éƒ¨ä½ç½®
    function showAllLocations() {
      // æ¸…é™¤URLåƒæ•¸
      const newUrl = `${window.location.origin}${window.location.pathname}`;
      window.history.pushState({}, '', newUrl);
      
      // æ¸…ç©ºè¼¸å…¥æ¬„
      document.getElementById('latInput').value = '';
      document.getElementById('lngInput').value = '';
      document.getElementById('radiusInput').value = '50';
      
      // é‡æ–°æ¸²æŸ“åœ°åœ–
      renderMap(null);
    }
    
    // è¤‡è£½URLåŠŸèƒ½
    function copyUrl() {
      const url = window.location.href;
      navigator.clipboard.writeText(url).then(() => {
        updateInfoPanel('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        setTimeout(() => {
          document.getElementById('infoPanel').style.display = 'none';
        }, 3000);
      }).catch(() => {
        // å‚™ç”¨æ–¹æ¡ˆ
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        updateInfoPanel('é€£çµå·²è¤‡è£½ï¼');
        setTimeout(() => {
          document.getElementById('infoPanel').style.display = 'none';
        }, 3000);
      });
    }
    
    // æ¸²æŸ“åœ°åœ–åŠŸèƒ½
    function renderMap(targetCoords, radiusKm = 50) {
      // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
      currentMarkers.clearLayers();
      if (centerMarker) {
        map.removeLayer(centerMarker);
        centerMarker = null;
      }
      
      let featuresToShow = allFeatures;
      let mapCenter = [31.9424765, 120.2903877]; // é è¨­ä¸­å¿ƒ
      let mapZoom = 7;
      
      if (targetCoords) {
        mapCenter = [targetCoords.lat, targetCoords.lng];
        mapZoom = 12;
        
        // ç¯©é¸é™„è¿‘çš„é»ä½
        featuresToShow = filterFeaturesByDistance(
          allFeatures, 
          targetCoords.lat, 
          targetCoords.lng, 
          radiusKm
        );
        
        // æ·»åŠ ä¸­å¿ƒæ¨™è¨˜
        const redIcon = L.divIcon({
          className: 'custom-red-marker',
          html: '<div style="background-color: #ef4444; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>',
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        });
        
        centerMarker = L.marker([targetCoords.lat, targetCoords.lng], { icon: redIcon })
          .addTo(map)
          .bindPopup(`<strong>ğŸ¯ æœå°‹ä¸­å¿ƒ</strong><br/>ç·¯åº¦: ${targetCoords.lat}<br/>ç¶“åº¦: ${targetCoords.lng}<br/>æœå°‹åŠå¾‘: ${radiusKm} å…¬é‡Œ`);
      }
      
      // è¨­å®šåœ°åœ–è¦–é‡
      map.setView(mapCenter, mapZoom);
      
      // é¡¯ç¤ºç¯©é¸å¾Œçš„é»ä½
      L.geoJSON({ type: 'FeatureCollection', features: featuresToShow }, {
        pointToLayer: (feature, latlng) => {
          const marker = L.marker(latlng);
          currentMarkers.addLayer(marker);
          return marker;
        },
        onEachFeature: (feature, layer) => {
          const props = feature.properties || {};
          let popupContent = '';
          let referenceLinks = [];

          Object.entries(props).forEach(([key, value]) => {
            if (key === 'èªªæ˜') {
              const urlRegex = /(https?:\/\/[^\s]+)/g;
              const matchedURLs = value.match(urlRegex);
              if (matchedURLs) {
                referenceLinks.push(...matchedURLs);
                value = value.replace(urlRegex, '').trim();
              }
            }
            popupContent += `<div><strong>${key}</strong>: ${value}</div>`;
          });

          // å¦‚æœæœ‰ç›®æ¨™åº§æ¨™ï¼Œé¡¯ç¤ºè·é›¢è³‡è¨Š
          if (targetCoords) {
            const coords = feature.geometry.coordinates;
            const distance = calculateDistance(targetCoords.lat, targetCoords.lng, coords[1], coords[0]);
            popupContent += `<div><strong>ğŸ“ è·é›¢æœå°‹ä¸­å¿ƒ</strong>: ${distance.toFixed(2)} å…¬é‡Œ</div>`;
          }

          if (referenceLinks.length) {
            popupContent += '<hr/>';
            referenceLinks.forEach(url => {
              popupContent += `<a class="link-btn" href="${url}" target="_blank">${getLabel(url)}</a><br/>`;
            });
          }

          layer.bindPopup(popupContent);
        }
      }).addTo(map);
      
      // å°‡æ¨™è¨˜ç¾¤çµ„æ·»åŠ åˆ°åœ°åœ–
      currentMarkers.addTo(map);
      
      // æ›´æ–°è³‡è¨Šé¢æ¿
      const message = targetCoords 
        ? `æ‰¾åˆ° ${featuresToShow.length} å€‹é»ä½ (${radiusKm}å…¬é‡Œå…§)`
        : `é¡¯ç¤ºå…¨éƒ¨ ${featuresToShow.length} å€‹é»ä½`;
      updateInfoPanel(message);
    }

    // ç•¶é é¢è¼‰å…¥å®Œæˆæ™‚å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
