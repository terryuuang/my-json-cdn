<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>溫SINT地圖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    
    /* 優化 Popup 樣式 */
    .leaflet-popup-content-wrapper {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 4px 16px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(226, 232, 240, 0.8);
      backdrop-filter: blur(10px);
    }
    
    .leaflet-popup-content {
      font-size: 14px;
      line-height: 1.5;
      margin: 16px 20px;
      color: #1e293b;
    }
    
    .leaflet-popup-tip {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border: 1px solid rgba(226, 232, 240, 0.8);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .popup-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .popup-icon {
      width: 24px;
      height: 24px;
      margin-right: 10px;
      flex-shrink: 0;
    }
    
    .popup-title {
      font-weight: 600;
      font-size: 16px;
      color: #0f172a;
      margin: 0;
    }
    
    .popup-field {
      margin-bottom: 8px;
      padding: 6px 0;
    }
    
    .popup-field strong {
      color: #475569;
      font-weight: 600;
      display: inline-block;
      min-width: 80px;
    }
    
    .popup-field-value {
      color: #1e293b;
      margin-left: 8px;
    }
    
    .popup-distance {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      padding: 8px 12px;
      border-radius: 8px;
      margin: 8px 0;
      border-left: 4px solid #3b82f6;
    }
    
    .popup-links {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e2e8f0;
    }
    
    .popup-links-title {
      font-size: 12px;
      color: #64748b;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .link-btn {
      display: inline-block;
      margin-bottom: 4px;
      padding: 4px 8px;
      border-radius: 6px;
      background: #f3f4f6;
      color: #374151;
      text-decoration: none;
      font-size: 12px;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #d1d5db;
    }
    .link-btn:hover { 
      background: #e5e7eb; 
      color: #1f2937;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border-color: #9ca3af;
    }
    
    /* 控制面板樣式 */
    .control-panel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 1000;
      min-width: 280px;
      max-width: 320px;
    }
    
    .control-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #1f2937;
      font-size: 16px;
    }
    
    .input-group {
      margin-bottom: 12px;
    }
    
    .input-label {
      display: block;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .input-field {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s ease;
      box-sizing: border-box;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    /* 優化下拉選單樣式 */
    select.input-field {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px;
      padding-right: 40px;
    }
    
    select.input-field:hover {
      border-color: #3b82f6;
    }
    
    /* 自定義軍事標記樣式 */
    .custom-military-marker {
      background: none !important;
      border: none !important;
    }
    
    /* 零距離標記動畫效果 */
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.2);
        opacity: 0.7;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    @keyframes pulseRing {
      0% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
      }
    }
    
    .zero-distance-marker {
      z-index: 1000 !important;
    }
    
    /* popup中零距離標記的微妙動畫 */
    @keyframes subtle-pulse {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.02);
        opacity: 0.95;
      }
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      color: #475569;
      border: 1px solid #cbd5e1;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      border: none;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }
    
    .btn-danger:hover {
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
    
    .info-panel {
      background: #f3f4f6;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      color: #4b5563;
      margin-top: 10px;
    }
    
    /* 載入指示器 */
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      z-index: 2000;
      text-align: center;
    }
    
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #2563eb;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* 隱藏控制面板的按鈕 */
    .toggle-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 1001;
      font-size: 18px;
    }
    
    .control-panel.hidden {
      transform: translateX(-100%);
      opacity: 0;
      pointer-events: none;
    }
    
    /* 手機版響應式設計 */
    @media (max-width: 768px) {
      .control-panel {
        position: fixed;
        top: 60px;
        left: 10px;
        right: 10px;
        max-width: none;
        min-width: auto;
        transform: translateX(-100%);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
      }
      
      .control-panel.show-mobile {
        transform: translateX(0);
        opacity: 1;
      }
      
      .toggle-panel {
        top: 10px;
        right: 10px;
        font-size: 20px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 10px;
        border: 1px solid rgba(0,0,0,0.1);
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .toggle-panel:active {
        transform: scale(0.95);
      }
      
      /* 手機版popup優化 */
      .leaflet-popup-content-wrapper {
        max-width: calc(100vw - 40px) !important;
        min-width: 280px;
      }
      
      .leaflet-popup-content {
        margin: 12px 16px !important;
        font-size: 13px;
        line-height: 1.4;
      }
      
      .popup-title {
        font-size: 14px;
      }
      
      .popup-icon {
        width: 20px;
        height: 20px;
      }
      
      .popup-field {
        margin-bottom: 6px;
        padding: 4px 0;
      }
      
      .popup-field strong {
        min-width: 70px;
        font-size: 12px;
      }
      
      .popup-field-value {
        font-size: 12px;
      }
      
      .popup-distance {
        padding: 6px 10px;
        margin: 6px 0;
        font-size: 12px;
      }
      
      .link-btn {
        padding: 3px 6px;
        font-size: 11px;
        margin-bottom: 3px;
      }
      
      .popup-links-title {
        font-size: 11px;
        margin-bottom: 6px;
      }
      
      /* 手機版控制面板內容優化 */
      .control-title {
        font-size: 15px;
        margin-bottom: 8px;
        position: relative;
      }
      
      .mobile-hint {
        font-size: 10px;
        color: #6b7280;
        background: #f3f4f6;
        padding: 4px 8px;
        border-radius: 6px;
        margin-bottom: 8px;
        text-align: center;
        border: 1px solid #e5e7eb;
      }
      
      .input-label {
        font-size: 11px;
        margin-bottom: 3px;
      }
      
      .input-field {
        padding: 6px 10px;
        font-size: 13px;
      }
      
      .btn {
        padding: 6px 12px;
        font-size: 12px;
        margin-right: 6px;
        margin-bottom: 6px;
      }
      
      .info-panel {
        padding: 6px 10px;
        font-size: 11px;
        margin-top: 8px;
      }
    }
    
    /* 極小螢幕優化 */
    @media (max-width: 480px) {
      .leaflet-popup-content-wrapper {
        max-width: calc(100vw - 20px) !important;
        min-width: 260px;
      }
      
      .control-panel {
        left: 5px;
        right: 5px;
        top: 55px;
      }
      
      .toggle-panel {
        right: 5px;
        padding: 10px;
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <!-- 載入指示器 -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>載入地圖資料中...</div>
  </div>
  
  <!-- 控制面板 -->
  <div id="controlPanel" class="control-panel" onclick="event.stopPropagation();">
    <div class="control-title">🗺️ 地圖控制</div>
    <div id="mobileHint" class="mobile-hint" style="display: none;">
      📱 點擊地圖任意處關閉此面板
    </div>
    
    <div class="input-group">
      <label class="input-label">緯度 (Latitude)</label>
      <input type="number" id="latInput" class="input-field" step="any" placeholder="例如: 31.9424765">
    </div>
    
    <div class="input-group">
      <label class="input-label">經度 (Longitude)</label>
      <input type="number" id="lngInput" class="input-field" step="any" placeholder="例如: 120.2903877">
    </div>
    
    <div class="input-group">
      <label class="input-label">搜尋半徑 (公里)</label>
      <input type="number" id="radiusInput" class="input-field" value="50" min="1" max="500" step="5">
    </div>
    
    <div class="input-group">
      <label class="input-label">分層篩選</label>
      <select id="layerFilter" class="input-field" onchange="filterByLayer()">
        <option value="">顯示全部分層</option>
        <option value="中國軍工及航天產業">🔧 中國軍工及航天產業</option>
        <option value="武裝警察、海外軍事設施及其他分類">🛡️ 武裝警察、海外軍事設施</option>
        <option value="解放軍海軍、海軍陸戰隊基地及設施">⚓ 解放軍海軍、海軍陸戰隊</option>
        <option value="解放軍火箭軍">🚀 解放軍火箭軍</option>
        <option value="解放軍空軍、海軍航空兵基地及設施">✈️ 解放軍空軍、海軍航空兵</option>
        <option value="解放軍軍事航天部隊、網路空間部隊、信息支援部隊">🛰️ 軍事航天、網路空間部隊</option>
        <option value="解放軍軍事院校、教育單位">🎓 解放軍軍事院校、教育</option>
        <option value="解放軍重要訓場/特殊設施">🎯 解放軍重要訓場/特殊設施</option>
        <option value="解放軍陸軍、陸軍防空單位、聯勤保障設施、預備役部隊(部分設施為個人推斷)">🪖 解放軍陸軍、聯勤保障</option>
        <option value="黨和國家重要政經軍事機關">🏛️ 黨和國家重要政經軍事機關</option>
      </select>
    </div>
    
    <button class="btn btn-primary" onclick="searchLocation()">🔍 搜尋位置</button>
    <button class="btn btn-secondary" onclick="showAllLocations()">🌍 顯示全部</button>
    <button class="btn btn-secondary" onclick="copyUrl()">📋 複製連結</button>
    
    <div id="infoPanel" class="info-panel" style="display: none;">
      <div id="infoText"></div>
    </div>
  </div>
  
  <!-- 隱藏面板按鈕 -->
  <button class="toggle-panel" onclick="togglePanel()">⚙️</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 解析URL參數 - 獲取經緯度
    function parseUrlCoordinates() {
      const urlParams = new URLSearchParams(window.location.search);
      
      // 支援多種參數格式
      // 格式1: ?lat=31.9424765&lng=120.2903877
      if (urlParams.has('lat') && urlParams.has('lng')) {
        return {
          lat: parseFloat(urlParams.get('lat')),
          lng: parseFloat(urlParams.get('lng'))
        };
      }
      
      // 格式2: ?coords=31.9424765,120.2903877
      if (urlParams.has('coords')) {
        const coords = urlParams.get('coords').split(',');
        if (coords.length === 2) {
          return {
            lat: parseFloat(coords[0]),
            lng: parseFloat(coords[1])
          };
        }
      }
      
      // 格式3: 路徑格式 /31.9424765,120.2903877 (向後相容)
      const path = window.location.pathname;
      const coordinatePattern = /\/(-?\d+\.?\d*),(-?\d+\.?\d*)$/;
      const match = path.match(coordinatePattern);
      
      if (match) {
        return {
          lat: parseFloat(match[1]),
          lng: parseFloat(match[2])
        };
      }
      
      return null;
    }

    // 計算兩點間距離(公里) - 使用Haversine公式
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // 地球半徑(公里)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // 初始化地圖
    function initializeMap() {
      map = L.map('map', { 
        zoomControl: false,
        maxZoom: 22, // 增加最大縮放級別，讓使用者可以看得更清楚
        minZoom: 2,
        tap: true, // 手機版點擊支援
        tapTolerance: 15 // 增加點擊容差
      }).setView([31.9424765, 120.2903877], 7);
      
      // 根據設備類型調整縮放控制器位置
      if (isMobileDevice()) {
        L.control.zoom({ position: 'bottomright' }).addTo(map);
      } else {
    L.control.zoom({ position: 'topright' }).addTo(map);
      }

      // 使用高解析度衛星圖層
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 22 // 支援高縮放級別
    }).addTo(map);

      // 手機版：點擊地圖關閉控制面板
      if (isMobileDevice()) {
        map.on('click', function() {
          const panel = document.getElementById('controlPanel');
          if (panel.classList.contains('show-mobile')) {
            panel.classList.remove('show-mobile');
          }
        });
      }
    }

    // SVG圖標系統
    const layerIcons = {
      '中國軍工及航天產業': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#4338ca" stroke="#312e81" stroke-width="2"/>
          <path d="M12 6v12M8 8l8 8M8 16l8-8" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="12" r="2" fill="white"/>
        </svg>`,
        color: '#4338ca'
      },
      '武裝警察、海外軍事設施及其他分類': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="6" width="18" height="12" rx="2" fill="#dc2626" stroke="#991b1b" stroke-width="2"/>
          <path d="M9 10h6M9 14h6" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <circle cx="7" cy="12" r="1" fill="white"/>
          <circle cx="17" cy="12" r="1" fill="white"/>
        </svg>`,
        color: '#dc2626'
      },
      '解放軍海軍、海軍陸戰隊基地及設施': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#0369a1" stroke="#075985" stroke-width="2"/>
          <path d="M6 12h12M12 6v12" stroke="white" stroke-width="2"/>
          <path d="M8 8l8 8M16 8l-8 8" stroke="white" stroke-width="1" opacity="0.7"/>
          <circle cx="12" cy="12" r="3" fill="none" stroke="white" stroke-width="1"/>
        </svg>`,
        color: '#0369a1'
      },
      '解放軍火箭軍': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#b91c1c" stroke="#7f1d1d" stroke-width="2"/>
          <path d="M12 4l2 4h-4l2-4zM12 4v16" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 10l8 0M8 14l8 0" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
          <path d="M10 18l4 0" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>`,
        color: '#b91c1c'
      },
      '解放軍空軍、海軍航空兵基地及設施': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#059669" stroke="#047857" stroke-width="2"/>
          <path d="M12 6l4 8h-8l4-8z" fill="white"/>
          <path d="M6 12h4M14 12h4" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <circle cx="12" cy="16" r="1" fill="white"/>
        </svg>`,
        color: '#059669'
      },
      '解放軍軍事航天部隊、網路空間部隊、信息支援部隊': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#7c3aed" stroke="#5b21b6" stroke-width="2"/>
          <circle cx="12" cy="8" r="2" fill="white"/>
          <path d="M12 10v4M10 14h4" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 16l8-8M16 16l-8-8" stroke="white" stroke-width="1" opacity="0.7"/>
        </svg>`,
        color: '#7c3aed'
      },
      '解放軍軍事院校、教育單位': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#ea580c" stroke="#c2410c" stroke-width="2"/>
          <rect x="8" y="8" width="8" height="6" rx="1" fill="white"/>
          <path d="M10 11h4M10 13h4" stroke="#ea580c" stroke-width="1" stroke-linecap="round"/>
          <path d="M12 8V6" stroke="white" stroke-width="2" stroke-linecap="round"/>
        </svg>`,
        color: '#ea580c'
      },
      '解放軍重要訓場/特殊設施': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#0d9488" stroke="#0f766e" stroke-width="2"/>
          <path d="M8 8h8l-2 2H10l-2-2zM8 16h8l-2-2H10l-2 2z" fill="white"/>
          <path d="M12 6v12" stroke="white" stroke-width="2"/>
          <circle cx="12" cy="12" r="1.5" fill="white"/>
        </svg>`,
        color: '#0d9488'
      },
      '解放軍陸軍、陸軍防空單位、聯勤保障設施、預備役部隊(部分設施為個人推斷)': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#16a34a" stroke="#15803d" stroke-width="2"/>
          <rect x="9" y="9" width="6" height="6" rx="1" fill="white"/>
          <path d="M11 11h2M11 13h2" stroke="#16a34a" stroke-width="1"/>
          <path d="M6 12h3M15 12h3M12 6v3M12 15v3" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
        </svg>`,
        color: '#16a34a'
      },
      '黨和國家重要政經軍事機關': {
        svg: `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" fill="#be123c" stroke="#9f1239" stroke-width="2"/>
          <path d="M8 10l4-2 4 2v6l-4 2-4-2v-6z" fill="white"/>
          <path d="M12 8v8M8 10l4 4 4-4" stroke="#be123c" stroke-width="1"/>
          <circle cx="12" cy="6" r="1" fill="white"/>
        </svg>`,
        color: '#be123c'
      }
    };

    // 根據layer獲取圖標
    function getLayerIcon(layerName) {
      return layerIcons[layerName] || layerIcons['武裝警察、海外軍事設施及其他分類'];
    }

    // 創建自定義標記圖標
    function createCustomIcon(layerName, isZeroDistance = false) {
      const iconData = getLayerIcon(layerName);
      const size = isZeroDistance ? 40 : 32; // 零距離標記稍大一點
      
      return L.divIcon({
        className: `custom-military-marker ${isZeroDistance ? 'zero-distance-marker' : ''}`,
        html: `
          <div style="
            width: ${size}px; 
            height: ${size}px; 
            position: relative;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            ${isZeroDistance ? `
              animation: pulseRing 2s infinite;
              border: 3px solid #ef4444;
              border-radius: 50%;
              background: rgba(239, 68, 68, 0.1);
              backdrop-filter: blur(4px);
            ` : ''}
          ">
            ${iconData.svg}
            ${isZeroDistance ? `
              <div style="
                position: absolute;
                top: -3px;
                right: -3px;
                width: 12px;
                height: 12px;
                background: #ef4444;
                border: 2px solid white;
                border-radius: 50%;
                animation: pulse 1.5s infinite;
                box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3);
              "></div>
            ` : ''}
          </div>
        `,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
        popupAnchor: [0, -size/2]
      });
    }

    // 取得標籤名稱
    function getLabel(url) {
      url = url.toLowerCase();
      return url.includes('twitter.com') || url.includes('x.com') ? 'Twitter/X' :
             url.includes('wikipedia.org') ? 'Wikipedia' :
             url.includes('weixin.qq.com') ? '微信公眾號' :
             url.includes('youtube.com') ? 'YouTube' :
             url.includes('thepaper.cn') ? '澎湃新聞' :
             url.includes('cctv.com') ? 'CCTV' :
             url.includes('bilibili.com') ? 'Bilibili' :
             '相關連結';
    }
    
    // 主要初始化函數
    async function init() {
      showLoading();
      
      try {
        // 初始化地圖
        initializeMap();
        
        // 初始化面板狀態（手機版預設隱藏）
        initializePanelState();
        
        // 監聽視窗大小變化
        window.addEventListener('resize', handleResize);
        
        // 解析URL參數
        const urlCoords = parseUrlCoordinates();
        const urlParams = new URLSearchParams(window.location.search);
        const radius = parseFloat(urlParams.get('radius')) || 50;
        const selectedLayer = urlParams.get('layer') || '';
        
        // 如果有URL參數，填入控制面板
        if (urlCoords) {
          document.getElementById('latInput').value = urlCoords.lat;
          document.getElementById('lngInput').value = urlCoords.lng;
        }
        document.getElementById('radiusInput').value = radius;
        document.getElementById('layerFilter').value = selectedLayer;
        
        // 載入地圖資料
        const geojsonURL = 'https://terryuuang.github.io/my-json-cdn/joseph_w-20250806.geojson';
        const response = await fetch(geojsonURL);
        
        if (!response.ok) {
          throw new Error(`載入資料失敗: ${response.status}`);
        }
        
        const data = await response.json();
        allFeatures = data.features;
        
        // 根據URL參數渲染地圖
        renderMap(urlCoords, radius, selectedLayer);
        
        hideLoading();
        
      } catch (error) {
        hideLoading();
        console.error('載入地圖資料時發生錯誤:', error);
        updateInfoPanel(`錯誤：${error.message}`);
        
        // 即使載入失敗也要初始化基本地圖
        if (!map) {
          initializeMap();
        }
      }
    }

    // 全域變數
    let map;
    let allFeatures = [];
    let currentMarkers = L.layerGroup();
    let centerMarker = null;

    // 篩選功能 - 根據距離篩選點位
    function filterFeaturesByDistance(features, centerLat, centerLng, radiusKm = 50) {
      return features.filter(feature => {
        const coords = feature.geometry.coordinates;
        const distance = calculateDistance(centerLat, centerLng, coords[1], coords[0]);
        return distance <= radiusKm;
      });
    }

    // 顯示載入指示器
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }
    
    // 隱藏載入指示器
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }
    
    // 更新資訊面板
    function updateInfoPanel(message) {
      const infoPanel = document.getElementById('infoPanel');
      const infoText = document.getElementById('infoText');
      infoText.textContent = message;
      infoPanel.style.display = 'block';
    }
    
    // 檢測是否為手機設備
    function isMobileDevice() {
      return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // 隱藏/顯示控制面板
    function togglePanel() {
      const panel = document.getElementById('controlPanel');
      
      if (isMobileDevice()) {
        // 手機版使用不同的class
        panel.classList.toggle('show-mobile');
      } else {
        // 桌面版使用原有的hidden class
        panel.classList.toggle('hidden');
      }
    }
    
    // 初始化面板顯示狀態
    function initializePanelState() {
      const panel = document.getElementById('controlPanel');
      const mobileHint = document.getElementById('mobileHint');
      
      if (isMobileDevice()) {
        // 手機版預設隱藏
        panel.classList.remove('show-mobile');
        // 確保不使用桌面版的hidden class
        panel.classList.remove('hidden');
        // 顯示手機版提示
        mobileHint.style.display = 'block';
      } else {
        // 桌面版預設顯示
        panel.classList.remove('hidden');
        panel.classList.remove('show-mobile');
        // 隱藏手機版提示
        mobileHint.style.display = 'none';
      }
    }
    
    // 監聽視窗大小變化
    function handleResize() {
      const panel = document.getElementById('controlPanel');
      const mobileHint = document.getElementById('mobileHint');
      
      if (isMobileDevice()) {
        // 切換到手機版
        panel.classList.remove('hidden');
        mobileHint.style.display = 'block';
        if (!panel.classList.contains('show-mobile')) {
          // 如果面板是開啟狀態，保持開啟
          const wasVisible = !panel.classList.contains('hidden');
          if (wasVisible) {
            panel.classList.add('show-mobile');
          }
        }
      } else {
        // 切換到桌面版
        panel.classList.remove('show-mobile');
        mobileHint.style.display = 'none';
        // 桌面版預設顯示
        panel.classList.remove('hidden');
      }
    }
    
    // 根據分層篩選特徵
    function filterFeaturesByLayer(features, selectedLayer) {
      if (!selectedLayer) return features;
      
      return features.filter(feature => {
        const props = feature.properties || {};
        const layerName = props.layer || props['分層'] || props['類別'] || '武裝警察、海外軍事設施及其他分類';
        return layerName === selectedLayer;
      });
    }
    
    // 分層篩選功能
    function filterByLayer() {
      const selectedLayer = document.getElementById('layerFilter').value;
      const urlCoords = parseUrlCoordinates();
      const urlParams = new URLSearchParams(window.location.search);
      const radius = parseFloat(urlParams.get('radius')) || 50;
      
      // 更新URL參數
      if (selectedLayer) {
        urlParams.set('layer', selectedLayer);
      } else {
        urlParams.delete('layer');
      }
      
      const newUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;
      window.history.pushState({}, '', newUrl);
      
      // 重新渲染地圖
      renderMap(urlCoords, radius, selectedLayer);
    }
    
    // 搜尋位置功能
    function searchLocation() {
      const lat = parseFloat(document.getElementById('latInput').value);
      const lng = parseFloat(document.getElementById('lngInput').value);
      const radius = parseFloat(document.getElementById('radiusInput').value) || 50;
      const selectedLayer = document.getElementById('layerFilter').value;
      
      if (isNaN(lat) || isNaN(lng)) {
        alert('請輸入有效的經緯度數值！');
        return;
      }
      
      // 更新URL
      const urlParams = new URLSearchParams();
      urlParams.set('lat', lat);
      urlParams.set('lng', lng);
      urlParams.set('radius', radius);
      if (selectedLayer) {
        urlParams.set('layer', selectedLayer);
      }
      
      const newUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;
      window.history.pushState({}, '', newUrl);
      
      // 重新渲染地圖
      renderMap({ lat, lng }, radius, selectedLayer);
    }
    
    // 顯示全部位置
    function showAllLocations() {
      // 清除URL參數
      const newUrl = `${window.location.origin}${window.location.pathname}`;
      window.history.pushState({}, '', newUrl);
      
      // 清空輸入欄
      document.getElementById('latInput').value = '';
      document.getElementById('lngInput').value = '';
      document.getElementById('radiusInput').value = '50';
      document.getElementById('layerFilter').value = '';
      
      // 重新渲染地圖
      renderMap(null);
    }
    
    // 複製URL功能
    function copyUrl() {
      const url = window.location.href;
      navigator.clipboard.writeText(url).then(() => {
        updateInfoPanel('連結已複製到剪貼簿！');
        setTimeout(() => {
          document.getElementById('infoPanel').style.display = 'none';
        }, 3000);
      }).catch(() => {
        // 備用方案
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        updateInfoPanel('連結已複製！');
        setTimeout(() => {
          document.getElementById('infoPanel').style.display = 'none';
        }, 3000);
      });
    }
    
    // 渲染地圖功能
    function renderMap(targetCoords, radiusKm = 50, selectedLayer = null) {
      // 清除現有標記
      currentMarkers.clearLayers();
      if (centerMarker) {
        map.removeLayer(centerMarker);
        centerMarker = null;
      }
      
      let featuresToShow = allFeatures;
      let mapCenter = [31.9424765, 120.2903877]; // 預設中心
      let mapZoom = 7;
      
      // 先進行分層篩選
      if (selectedLayer) {
        featuresToShow = filterFeaturesByLayer(featuresToShow, selectedLayer);
      }
      
      // 然後進行地理位置篩選
      if (targetCoords) {
        mapCenter = [targetCoords.lat, targetCoords.lng];
        mapZoom = 15; // 增加預設縮放級別，讓用戶能看得更清楚
        
        // 篩選附近的點位
          featuresToShow = filterFeaturesByDistance(
          featuresToShow, 
          targetCoords.lat, 
          targetCoords.lng, 
          radiusKm
        );
        
        // 添加中心標記
          const redIcon = L.divIcon({
            className: 'custom-red-marker',
          html: '<div style="background-color: #ef4444; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          });
          
        centerMarker = L.marker([targetCoords.lat, targetCoords.lng], { icon: redIcon })
           .addTo(map)
          .bindPopup(`<strong>🎯 搜尋中心</strong><br/>緯度: ${targetCoords.lat}<br/>經度: ${targetCoords.lng}<br/>搜尋半徑: ${radiusKm} 公里`);
        }
      
      // 設定地圖視野
      map.setView(mapCenter, mapZoom);

        // 顯示篩選後的點位
        L.geoJSON({ type: 'FeatureCollection', features: featuresToShow }, {
        pointToLayer: (feature, latlng) => {
          const props = feature.properties || {};
          const layerName = props.layer || props['分層'] || props['類別'] || '武裝警察、海外軍事設施及其他分類';
          
          // 檢查是否為零距離點位（距離搜尋中心很近）
          let isZeroDistance = false;
          if (targetCoords) {
            const coords = feature.geometry.coordinates;
            const distance = calculateDistance(targetCoords.lat, targetCoords.lng, coords[1], coords[0]);
            isZeroDistance = distance < 0.1; // 小於100公尺視為零距離
          }
          
          const customIcon = createCustomIcon(layerName, isZeroDistance);
          const marker = L.marker(latlng, { icon: customIcon });
          currentMarkers.addLayer(marker);
          return marker;
        },
          onEachFeature: (feature, layer) => {
            const props = feature.properties || {};
          const layerName = props.layer || props['分層'] || props['類別'] || '武裝警察、海外軍事設施及其他分類';
          const iconData = getLayerIcon(layerName);
          
            let popupContent = '';
            let referenceLinks = [];
          let mainTitle = props['名稱'] || props['name'] || '軍事設施';

          // 構建popup標題
          popupContent += `
            <div class="popup-header">
              <div class="popup-icon">${iconData.svg}</div>
              <h3 class="popup-title">${mainTitle}</h3>
            </div>
          `;

          // 顯示分層資訊
          popupContent += `
            <div class="popup-field">
              <strong>分層類別:</strong>
              <span class="popup-field-value" style="color: ${iconData.color}; font-weight: 600;">${layerName}</span>
            </div>
          `;

          // 處理其他屬性
            Object.entries(props).forEach(([key, value]) => {
              if (key === '說明') {
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                const matchedURLs = value.match(urlRegex);
                if (matchedURLs) {
                  referenceLinks.push(...matchedURLs);
                  value = value.replace(urlRegex, '').trim();
                }
              }
            
            // 跳過已處理的欄位
            if (['名稱', 'name', 'layer', '分層', '類別'].includes(key)) return;
            
            if (value && value.toString().trim()) {
              popupContent += `
                <div class="popup-field">
                  <strong>${key}:</strong>
                  <span class="popup-field-value">${value}</span>
                </div>
              `;
            }
          });

          // 如果有目標座標，顯示距離資訊
          if (targetCoords) {
              const coords = feature.geometry.coordinates;
            const distance = calculateDistance(targetCoords.lat, targetCoords.lng, coords[1], coords[0]);
            const isZeroDistance = distance < 0.1;
            
            if (isZeroDistance) {
              popupContent += `
                <div class="popup-distance" style="
                  background: linear-gradient(135deg, #fef2f2, #fee2e2);
                  border-left: 4px solid #ef4444;
                  border: 2px solid #ef4444;
                  animation: subtle-pulse 2s infinite;
                ">
                  <strong>🎯 就在搜尋中心!</strong> 
                  <span style="color: #ef4444; font-weight: 700;">
                    ${distance < 0.01 ? '< 10公尺' : `${(distance * 1000).toFixed(0)}公尺`}
                  </span>
                  <br/>
                  <small style="color: #dc2626;">這個設施就在您指定的位置附近</small>
                </div>
              `;
            } else {
              popupContent += `
                <div class="popup-distance">
                  <strong>📍 距離搜尋中心:</strong> ${distance.toFixed(2)} 公里
                </div>
              `;
            }
          }

          // 添加參考連結
            if (referenceLinks.length) {
            popupContent += `
              <div class="popup-links">
                <div class="popup-links-title">相關連結</div>
            `;
              referenceLinks.forEach(url => {
                popupContent += `<a class="link-btn" href="${url}" target="_blank">${getLabel(url)}</a><br/>`;
              });
            popupContent += '</div>';
          }

          // 根據設備類型調整popup設定
          const popupOptions = {
            className: 'custom-popup'
          };
          
          if (isMobileDevice()) {
            popupOptions.maxWidth = Math.min(350, window.innerWidth - 40);
            popupOptions.minWidth = Math.min(260, window.innerWidth - 60);
            popupOptions.autoPan = true;
            popupOptions.autoPanPadding = [10, 10];
            popupOptions.closeButton = true;
          } else {
            popupOptions.maxWidth = 350;
            popupOptions.minWidth = 280;
          }
          
          layer.bindPopup(popupContent, popupOptions);
          }
        }).addTo(map);

      // 將標記群組添加到地圖
      currentMarkers.addTo(map);
      
      // 更新資訊面板
      let message = `顯示 ${featuresToShow.length} 個點位`;
      
      if (selectedLayer) {
        message += ` (${selectedLayer})`;
      }
      
      if (targetCoords) {
        message += ` (${radiusKm}公里內)`;
      }
      
      updateInfoPanel(message);
    }

    // 當頁面載入完成時啟動應用程式
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
