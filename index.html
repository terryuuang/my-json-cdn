<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>溫SINT地圖 - APEINTEL ATLAS</title>
  
  <!-- ============================================
       基礎 Meta 標籤
       ============================================ -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="description" content="APEINTEL ATLAS - 互動式地理資訊地圖">
  <meta name="author" content="APEINTEL">
  <meta name="keywords" content="地圖,軍事,設施,OSINT,情報,GeoJSON">

  <!-- ============================================
       OpenGraph 社群媒體預覽標籤
       ============================================ -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://rnap.riotoolkit.cc">
  <meta property="og:site_name" content="APEINTEL ATLAS">
  <meta property="og:title" content="溫SINT地圖">
  <meta property="og:description" content="互動式地理資訊地圖">
  <meta property="og:image" content="static/assets/opengraph.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:locale" content="zh_TW">

  <!-- ============================================
       PWA 通用設定
       ============================================ -->
  <!-- 狀態欄顏色：淺色模式用淺色，深色模式用深色 -->
  <meta name="theme-color" content="#f8fafc" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#1a1a2e" media="(prefers-color-scheme: dark)">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="APEINTEL ATLAS">
  <meta name="msapplication-TileColor" content="#1a1a2e">
  <meta name="msapplication-TileImage" content="static/assets/APP_LOGO_192x192.png">
  <meta name="msapplication-config" content="none">
  
  <!-- ============================================
       iOS/Safari 完整設定（原生 APP 體驗）
       ============================================ -->
  <!-- 啟用全螢幕模式 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- 狀態欄樣式：default 讓狀態欄符合系統深淺色模式 -->
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <!-- APP 名稱（主畫面顯示） -->
  <meta name="apple-mobile-web-app-title" content="APEINTEL ATLAS">
  <!-- 停用自動偵測電話號碼（避免誤觸） -->
  <meta name="format-detection" content="telephone=no">
  <!-- 停用自動偵測地址 -->
  <meta name="format-detection" content="address=no">
  <!-- 停用自動偵測 Email -->
  <meta name="format-detection" content="email=no">
  <!-- 停用自動偵測日期 -->
  <meta name="format-detection" content="date=no">
  <!-- 觸控高亮顏色（設為透明以獲得原生感） -->
  <meta name="apple-touch-fullscreen" content="yes">
  
  <!-- ============================================
       Android/Chrome 設定
       ============================================ -->
  <!-- 停用翻譯提示 -->
  <meta name="google" content="notranslate">
  
  <!-- ============================================
       PWA Manifest
       ============================================ -->
  <link rel="manifest" href="manifest.json">
  
  <!-- ============================================
       Favicon 和圖示
       ============================================ -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="icon" type="image/png" sizes="192x192" href="static/assets/APP_LOGO_192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="static/assets/APP_LOGO_512x512.png">
  
  <!-- ============================================
       Apple Touch Icons（iOS 主畫面圖示）
       ============================================ -->
  <!-- 預設 -->
  <link rel="apple-touch-icon" href="static/assets/APP_LOGO_180x180.png">
  <!-- iPad (非 Retina) -->
  <link rel="apple-touch-icon" sizes="76x76" href="static/assets/APP_LOGO_152x152.png">
  <!-- iPad (Retina) -->
  <link rel="apple-touch-icon" sizes="152x152" href="static/assets/APP_LOGO_152x152.png">
  <!-- iPhone (Retina) -->
  <link rel="apple-touch-icon" sizes="180x180" href="static/assets/APP_LOGO_180x180.png">
  <!-- iPad Pro -->
  <link rel="apple-touch-icon" sizes="167x167" href="static/assets/APP_LOGO_180x180.png">
  
  <!-- ============================================
       iOS 啟動畫面（Splash Screen）
       注意：iOS 需要完整螢幕解析度的圖片才會顯示
       目前使用 background_color 作為啟動畫面背景
       ============================================ -->

  <!-- ============================================
       樣式表預載與載入
       ============================================ -->
  <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Plugins: Leaflet.draw + PolylineMeasure -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.css" />
  <!-- Bootstrap Icons for OSM facility markers -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="static/css/main.css">
</head>
<body>
  <!-- 頂部提醒 -->
  <div id="topNotice" class="top-notice" role="status" aria-live="polite">
    ⚠️ 圖資 preload 可能造成首次卡頓；遇效能問題可重新整理
  </div>
  <div id="map"></div>

  <!-- 載入指示器 -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>載入地圖資料中...</div>
  </div>

  <!-- 手機版固定搜尋列 -->
  <div id="mobileSearchBar" class="mobile-search-bar">
    <div class="mobile-search-container">
      <button class="mobile-toggle-panel" onclick="togglePanel()" aria-label="開啟地圖控制">
        <i class="bi bi-list"></i>
      </button>
      <div class="mobile-search-input-wrapper">
        <input type="text" id="mobileSearchInput" class="mobile-search-input" placeholder="搜尋地點..." autocomplete="off" aria-label="搜尋地點">
        <button id="mobileClearBtn" class="mobile-clear-btn" onclick="clearMobileSearch()" aria-label="清除搜尋" style="display: none;">✕</button>
      </div>
    </div>
    <div id="mobileSearchResults" class="mobile-search-results" style="display: none;" role="listbox" aria-label="搜尋結果"></div>
  </div>

  <!-- 背景遮罩 (用於手機版點擊關閉面板) -->
  <div id="panelBackdrop" class="panel-backdrop" onclick="closePanel()"></div>

  <!-- 控制面板 -->
  <div id="controlPanel" class="control-panel" onclick="event.stopPropagation();">
    <div class="control-title">地圖控制</div>

    <!-- 地點搜尋 -->
    <div class="input-group">
      <label class="input-label">搜尋地點</label>
      <div class="search-container">
        <input type="text" id="searchInput" class="input-field search-input" placeholder="輸入地點名稱..." autocomplete="off" aria-label="搜尋地點">
        <button class="btn btn-search" onclick="performSearch()" aria-label="執行搜尋">搜尋</button>
      </div>
      <div id="searchResults" class="search-results" style="display: none;" role="listbox" aria-label="搜尋結果"></div>
    </div>

    <div class="input-group">
      <label class="input-label">緯度 (Latitude)</label>
      <input type="number" id="latInput" class="input-field" step="any" placeholder="例如: 31.9424765">
    </div>

    <div class="input-group">
      <label class="input-label">經度 (Longitude)</label>
      <input type="number" id="lngInput" class="input-field" step="any" placeholder="例如: 120.2903877">
    </div>

    <div class="input-group">
      <label class="input-label">搜尋半徑 (公里)</label>
      <input type="number" id="radiusInput" class="input-field" value="50" min="1" max="500" step="5">
    </div>

    <!-- 分層篩選 (改為多選下拉選單) -->
    <div class="input-group">
      <label class="input-label">單位篩選</label>
      <div class="unified-dropdown">
        <button type="button" class="dropdown-toggle" onclick="toggleLayerDropdown()" aria-label="選擇圖層">
          <span id="layerSelectedCount">顯示全部分層</span>
          <span class="dropdown-arrow">▼</span>
        </button>
        <div id="layerDropdownMenu" class="dropdown-menu" style="display: none;">
          <div class="dropdown-content">
            <div class="dropdown-option">
              <label><input type="checkbox" value="中國軍工及航天產業" onchange="handleLayerChange(this)"><span>中共軍工及航天產業</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="武裝警察、海外軍事設施及其他分類" onchange="handleLayerChange(this)"><span>武裝警察、海外軍事設施</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍海軍、海軍陸戰隊基地及設施" onchange="handleLayerChange(this)"><span>共軍海軍、海軍陸戰隊</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍火箭軍" onchange="handleLayerChange(this)"><span>共軍火箭軍</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍空軍、海軍航空兵基地及設施" onchange="handleLayerChange(this)"><span>共軍空軍、海軍航空兵</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍軍事航天部隊、網路空間部隊、信息支援部隊" onchange="handleLayerChange(this)"><span>軍事航天、網路空間部隊</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍軍事院校、教育單位" onchange="handleLayerChange(this)"><span>共軍軍事院校、教育</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍重要訓場/特殊設施" onchange="handleLayerChange(this)"><span>共軍重要訓場/特殊設施</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍陸軍、陸軍防空單位、聯勤保障設施、預備役部隊(部分設施為個人推斷)" onchange="handleLayerChange(this)"><span>共軍陸軍、聯勤保障</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="黨和國家重要政經軍事機關" onchange="handleLayerChange(this)"><span>共產黨和國家重要政經軍事機關</span></label>
            </div>
          </div>
          <div class="dropdown-actions" style="display: none;">
          </div>
        </div>
      </div>
    </div>

    <!-- OSM 公共設施圖層選擇 (改用統一樣式) -->
    <div class="input-group">
      <label class="input-label">公共設施</label>
      <div class="unified-dropdown">
        <button type="button" class="dropdown-toggle" onclick="toggleOSMDropdown()" aria-label="選擇公共設施圖層">
          <span id="osmSelectedCount">選擇設施類型</span>
          <span class="dropdown-arrow">▼</span>
        </button>
        <div id="osmDropdownMenu" class="dropdown-menu" style="display: none;">
          <div class="dropdown-content">
            <div class="dropdown-option">
              <label><input type="checkbox" value="surveillance" onchange="handleOSMFacilityChange(this)"><span>監視設備</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="school" onchange="handleOSMFacilityChange(this)"><span>學校</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="university" onchange="handleOSMFacilityChange(this)"><span>大學</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="college" onchange="handleOSMFacilityChange(this)"><span>學院</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="hospital" onchange="handleOSMFacilityChange(this)"><span>醫療設施</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="stadium" onchange="handleOSMFacilityChange(this)"><span>體育場</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="sports_centre" onchange="handleOSMFacilityChange(this)"><span>運動中心</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="parking" onchange="handleOSMFacilityChange(this)"><span>停車場</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="fuel" onchange="handleOSMFacilityChange(this)"><span>加油站</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="helipad" onchange="handleOSMFacilityChange(this)"><span>直升機停機坪</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="airport" onchange="handleOSMFacilityChange(this)"><span>機場</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="tower" onchange="handleOSMFacilityChange(this)"><span>高塔</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="water_tower" onchange="handleOSMFacilityChange(this)"><span>水塔</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="bridge" onchange="handleOSMFacilityChange(this)"><span>橋樑</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="power_station" onchange="handleOSMFacilityChange(this)"><span>發電廠</span></label>
            </div>
          </div>
          <div class="dropdown-actions">
            <button type="button" class="btn-dropdown-action" onclick="clearAllOSMSelections()">清除全部</button>
          </div>
        </div>
      </div>
    </div>
    
    <button class="btn btn-primary" onclick="searchLocation()">搜尋位置</button>
    <button class="btn btn-secondary" id="toggleUnitsBtn" onclick="toggleUnitsVisibility()">隱藏單位</button>
    <button class="btn btn-secondary" onclick="clearDrawings()">清除繪圖</button>
    
    <div id="infoPanel" class="info-panel" style="display: none;">
      <div id="infoText"></div>
    </div>
  </div>
  
  <!-- 隱藏面板按鈕 -->
  <button class="toggle-panel" onclick="togglePanel()" aria-label="開啟地圖控制">
    <i class="bi bi-list"></i>
  </button>

  <!-- 更新日誌 Modal -->
  <div id="changelogModal" class="changelog-modal" onclick="closeChangelog()">
    <div class="changelog-content" onclick="event.stopPropagation()">
      <div class="changelog-header">
        <h3>更新日誌</h3>
        <button class="changelog-close" onclick="closeChangelog()" aria-label="關閉">✕</button>
      </div>
      <div class="changelog-body">
        <!-- 內容將由 JavaScript 動態生成 -->
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" defer></script>
  <script src="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.min.js" defer></script>
  <!-- OpenCC.js for Traditional/Simplified Chinese conversion -->
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
  <script src="static/js/shape_utils.js" defer></script>
  <script src="static/js/equipment_parser.js" defer></script>
  <script src="static/js/search_utils.js" defer></script>
  <!-- OSM Facilities -->
  <script src="static/js/osm_facilities.js" defer></script>
  <!-- Unified Dropdown System -->
  <script src="static/js/unified_dropdown.js" defer></script>
  <!-- Notes System (IndexedDB) -->
  <script src="static/js/notes.js" defer></script>
  <!-- Supabase Authentication & Cloud Sync -->
  <script src="static/js/supabase_auth.js" defer></script>
  <!-- Chat System -->
  <script src="static/js/chat.js" defer></script>
  <!-- PWA -->
  <script src="static/js/pwa.js" defer></script>
  <script src="static/js/main.js" defer></script>
</body>
</html>
