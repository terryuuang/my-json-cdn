<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>溫SINT地圖</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="preload" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Plugins: Leaflet.draw + PolylineMeasure -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.css" />
  <!-- Bootstrap Icons for OSM facility markers -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="static/css/main.css">
</head>
<body>
  <!-- 頂部提醒 -->
  <div id="topNotice" class="top-notice" role="status" aria-live="polite">
    ⚠️ 圖資 preload 可能造成首次卡頓；遇效能問題可重新整理
  </div>
  <div id="map"></div>

  <!-- 載入指示器 -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>載入地圖資料中...</div>
  </div>

  <!-- 手機版固定搜尋列 -->
  <div id="mobileSearchBar" class="mobile-search-bar">
    <div class="mobile-search-container">
      <button class="mobile-toggle-panel" onclick="togglePanel()" aria-label="開啟地圖控制">⚙️</button>
      <div class="mobile-search-input-wrapper">
        <input type="text" id="mobileSearchInput" class="mobile-search-input" placeholder="搜尋地點..." autocomplete="off" aria-label="搜尋地點">
        <button id="mobileClearBtn" class="mobile-clear-btn" onclick="clearMobileSearch()" aria-label="清除搜尋" style="display: none;">✕</button>
      </div>
    </div>
    <div id="mobileSearchResults" class="mobile-search-results" style="display: none;" role="listbox" aria-label="搜尋結果"></div>
  </div>

  <!-- 背景遮罩 (用於手機版點擊關閉面板) -->
  <div id="panelBackdrop" class="panel-backdrop" onclick="closePanel()"></div>

  <!-- 控制面板 -->
  <div id="controlPanel" class="control-panel" onclick="event.stopPropagation();">
    <div class="control-title">地圖控制</div>

    <!-- 地點搜尋 -->
    <div class="input-group">
      <label class="input-label">搜尋地點</label>
      <div class="search-container">
        <input type="text" id="searchInput" class="input-field search-input" placeholder="輸入地點名稱..." autocomplete="off" aria-label="搜尋地點">
        <button class="btn btn-search" onclick="performSearch()" aria-label="執行搜尋">搜尋</button>
      </div>
      <div id="searchResults" class="search-results" style="display: none;" role="listbox" aria-label="搜尋結果"></div>
    </div>

    <div class="input-group">
      <label class="input-label">緯度 (Latitude)</label>
      <input type="number" id="latInput" class="input-field" step="any" placeholder="例如: 31.9424765">
    </div>

    <div class="input-group">
      <label class="input-label">經度 (Longitude)</label>
      <input type="number" id="lngInput" class="input-field" step="any" placeholder="例如: 120.2903877">
    </div>

    <div class="input-group">
      <label class="input-label">搜尋半徑 (公里)</label>
      <input type="number" id="radiusInput" class="input-field" value="50" min="1" max="500" step="5">
    </div>

    <!-- 分層篩選 (改為多選下拉選單) -->
    <div class="input-group">
      <label class="input-label">單位篩選</label>
      <div class="unified-dropdown">
        <button type="button" class="dropdown-toggle" onclick="toggleLayerDropdown()" aria-label="選擇圖層">
          <span id="layerSelectedCount">顯示全部分層</span>
          <span class="dropdown-arrow">▼</span>
        </button>
        <div id="layerDropdownMenu" class="dropdown-menu" style="display: none;">
          <div class="dropdown-content">
            <div class="dropdown-option">
              <label><input type="checkbox" value="中國軍工及航天產業" onchange="handleLayerChange(this)"><span>中國軍工及航天產業</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="武裝警察、海外軍事設施及其他分類" onchange="handleLayerChange(this)"><span>武裝警察、海外軍事設施</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍海軍、海軍陸戰隊基地及設施" onchange="handleLayerChange(this)"><span>解放軍海軍、海軍陸戰隊</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍火箭軍" onchange="handleLayerChange(this)"><span>解放軍火箭軍</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍空軍、海軍航空兵基地及設施" onchange="handleLayerChange(this)"><span>解放軍空軍、海軍航空兵</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍軍事航天部隊、網路空間部隊、信息支援部隊" onchange="handleLayerChange(this)"><span>軍事航天、網路空間部隊</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍軍事院校、教育單位" onchange="handleLayerChange(this)"><span>解放軍軍事院校、教育</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍重要訓場/特殊設施" onchange="handleLayerChange(this)"><span>解放軍重要訓場/特殊設施</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="解放軍陸軍、陸軍防空單位、聯勤保障設施、預備役部隊(部分設施為個人推斷)" onchange="handleLayerChange(this)"><span>解放軍陸軍、聯勤保障</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="黨和國家重要政經軍事機關" onchange="handleLayerChange(this)"><span>黨和國家重要政經軍事機關</span></label>
            </div>
          </div>
          <div class="dropdown-actions" style="display: none;">
          </div>
        </div>
      </div>
    </div>

    <!-- OSM 公共設施圖層選擇 (改用統一樣式) -->
    <div class="input-group">
      <label class="input-label">公共設施</label>
      <div class="unified-dropdown">
        <button type="button" class="dropdown-toggle" onclick="toggleOSMDropdown()" aria-label="選擇公共設施圖層">
          <span id="osmSelectedCount">選擇設施類型</span>
          <span class="dropdown-arrow">▼</span>
        </button>
        <div id="osmDropdownMenu" class="dropdown-menu" style="display: none;">
          <div class="dropdown-content">
            <div class="dropdown-option">
              <label><input type="checkbox" value="surveillance" onchange="handleOSMFacilityChange(this)"><span>監視設備</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="school" onchange="handleOSMFacilityChange(this)"><span>學校</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="university" onchange="handleOSMFacilityChange(this)"><span>大學</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="college" onchange="handleOSMFacilityChange(this)"><span>學院</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="hospital" onchange="handleOSMFacilityChange(this)"><span>醫療設施</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="stadium" onchange="handleOSMFacilityChange(this)"><span>體育場</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="sports_centre" onchange="handleOSMFacilityChange(this)"><span>運動中心</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="parking" onchange="handleOSMFacilityChange(this)"><span>停車場</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="fuel" onchange="handleOSMFacilityChange(this)"><span>加油站</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="helipad" onchange="handleOSMFacilityChange(this)"><span>直升機停機坪</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="airport" onchange="handleOSMFacilityChange(this)"><span>機場</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="tower" onchange="handleOSMFacilityChange(this)"><span>高塔</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="water_tower" onchange="handleOSMFacilityChange(this)"><span>水塔</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="bridge" onchange="handleOSMFacilityChange(this)"><span>橋樑</span></label>
            </div>
            <div class="dropdown-option">
              <label><input type="checkbox" value="power_station" onchange="handleOSMFacilityChange(this)"><span>發電廠</span></label>
            </div>
          </div>
          <div class="dropdown-actions">
            <button type="button" class="btn-dropdown-action" onclick="clearAllOSMSelections()">清除全部</button>
          </div>
        </div>
      </div>
    </div>
    
    <button class="btn btn-primary" onclick="searchLocation()">搜尋位置</button>
    <button class="btn btn-secondary" id="toggleUnitsBtn" onclick="toggleUnitsVisibility()">隱藏單位</button>
    <button class="btn btn-secondary" onclick="clearDrawings()">清除繪圖</button>
    
    <div id="infoPanel" class="info-panel" style="display: none;">
      <div id="infoText"></div>
    </div>
  </div>
  
  <!-- 隱藏面板按鈕 -->
  <button class="toggle-panel" onclick="togglePanel()">⚙️</button>

  <!-- 更新日誌 Modal -->
  <div id="changelogModal" class="changelog-modal" onclick="closeChangelog()">
    <div class="changelog-content" onclick="event.stopPropagation()">
      <div class="changelog-header">
        <h3>更新日誌</h3>
        <button class="changelog-close" onclick="closeChangelog()" aria-label="關閉">✕</button>
      </div>
      <div class="changelog-body">
        <!-- 內容將由 JavaScript 動態生成 -->
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" defer></script>
  <script src="https://unpkg.com/leaflet.polylinemeasure/Leaflet.PolylineMeasure.min.js" defer></script>
  <!-- OpenCC.js for Traditional/Simplified Chinese conversion -->
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
  <script src="static/js/shape_utils.js" defer></script>
  <script src="static/js/equipment_parser.js" defer></script>
  <script src="static/js/search_utils.js" defer></script>
  <!-- OSM Facilities -->
  <script src="static/js/osm_facilities.js" defer></script>
  <!-- Unified Dropdown System -->
  <script src="static/js/unified_dropdown.js" defer></script>
  <script src="static/js/main.js" defer></script>
</body>
</html>
