# APEINTEL ATLAS - Supabase é›²ç«¯åŒæ­¥è¨­å®šæŒ‡å—

æœ¬æŒ‡å—èªªæ˜å¦‚ä½•è¨­å®š Supabase å¾Œå°ä»¥å•Ÿç”¨ APEINTEL ATLAS çš„é›²ç«¯åŒæ­¥åŠŸèƒ½ã€‚

## åŠŸèƒ½æ¦‚è¦½

å®Œæˆè¨­å®šå¾Œï¼Œæ‚¨çš„ç¶²ç«™å°‡æ”¯æ´ï¼š

- âœ… Google OAuth ç™»å…¥
- âœ… **ç”¨æˆ¶å¯©æ ¸ç³»çµ±**ï¼ˆæ–°ç”¨æˆ¶éœ€ç®¡ç†å“¡æ‰¹å‡†ï¼‰
- âœ… ç­†è¨˜é›²ç«¯åŒæ­¥ï¼ˆä½¿ç”¨ Supabase Storageï¼‰
- âœ… **è‡ªå‹•å®šæ™‚åŒæ­¥**ï¼ˆå¯é–‹é—œï¼Œé è¨­ 5 åˆ†é˜ï¼‰
- âœ… **å„²å­˜ç©ºé–“ç®¡ç†**ï¼ˆæ¯ä½ç”¨æˆ¶ 15MBï¼Œç®¡ç†å“¡å¯èª¿æ•´ï¼‰
- âœ… **ç·šä¸Šç‹€æ…‹é¡¯ç¤º**ï¼ˆé¡¯ç¤ºåœ¨ç·šç”¨æˆ¶ï¼‰
- âœ… **ç®¡ç†å“¡é¢æ¿**ï¼ˆå¯©æ ¸ç”¨æˆ¶ã€èª¿æ•´é…é¡ã€ç¦ç”¨å¸³è™Ÿï¼‰
- ğŸ”œ ç¾¤èŠåŠŸèƒ½ï¼ˆé ç•™ï¼‰
- ğŸ”œ ç§è¨ŠåŠŸèƒ½ï¼ˆé ç•™ï¼‰
- ğŸ”œ Web Push é€šçŸ¥ï¼ˆé ç•™ï¼‰

---

## ç”¨æˆ¶å¯©æ ¸æµç¨‹

```
æ–°ç”¨æˆ¶è¨»å†Š â†’ pending (ç­‰å¾…å¯©æ ¸)
    â†“
ç®¡ç†å“¡æ‰¹å‡† â†’ approved (å¯ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½)
    æˆ–
ç®¡ç†å“¡æ‹’çµ• â†’ rejected (ç„¡æ³•ä½¿ç”¨)
    â†“
ç®¡ç†å“¡å¯éš¨æ™‚ â†’ banned (ç¦ç”¨å·²æ‰¹å‡†çš„ç”¨æˆ¶)
```

**æ³¨æ„**ï¼šç®¡ç†å“¡å¸³è™Ÿï¼ˆ`terrywang981231@gmail.com` å’Œ `bob805606569@gmail.com`ï¼‰é¦–æ¬¡ç™»å…¥æ™‚æœƒè‡ªå‹•ç²å¾—æ‰¹å‡†ã€‚

---

## è¨­å®šæ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šå»ºç«‹ Supabase å°ˆæ¡ˆ

1. å‰å¾€ [Supabase Dashboard](https://app.supabase.com/)
2. é»æ“Šã€ŒNew Projectã€å»ºç«‹æ–°å°ˆæ¡ˆ
3. è¨˜ä¸‹æ‚¨çš„ **Project URL** å’Œ **anon public** API Key

### æ­¥é©Ÿ 2ï¼šè¨­å®š Google OAuth

#### 2.1 Google Cloud Console è¨­å®š

1. å‰å¾€ [Google Cloud Console](https://console.cloud.google.com/)
2. é¸æ“‡æˆ–å»ºç«‹å°ˆæ¡ˆ
3. å‰å¾€ã€ŒAPIs & Servicesã€â†’ã€ŒCredentialsã€
4. é»æ“Šã€ŒCreate Credentialsã€â†’ã€ŒOAuth client IDã€
5. é¸æ“‡ã€ŒWeb applicationã€
6. è¨­å®šï¼š
   - **åç¨±**ï¼šAPEINTEL ATLAS
   - **æˆæ¬Šçš„ JavaScript ä¾†æº**ï¼š
     - `https://rnap.riotoolkit.cc`
     - `http://localhost:8080`ï¼ˆé–‹ç™¼ç”¨ï¼‰
   - **æˆæ¬Šçš„é‡æ–°å°å‘ URI**ï¼š
     - `https://uxmfhlvmhyktfujcrwao.supabase.co/auth/v1/callback`
7. è¨˜ä¸‹ **Client ID** å’Œ **Client Secret**

#### 2.2 Supabase Dashboard è¨­å®š

1. å‰å¾€ Supabase Dashboard â†’ Authentication â†’ Providers
2. æ‰¾åˆ° **Google** ä¸¦å•Ÿç”¨
3. è²¼ä¸Š Google OAuth çš„ Client ID å’Œ Client Secret
4. å„²å­˜è¨­å®š

#### 2.3 è¨­å®š Redirect URLs

1. å‰å¾€ Authentication â†’ URL Configuration
2. è¨­å®šï¼š
   - **Site URL**ï¼š`https://rnap.riotoolkit.cc`
   - **Redirect URLs** æ–°å¢ï¼š
     - `https://rnap.riotoolkit.cc`
     - `http://localhost:8080`ï¼ˆé–‹ç™¼ç”¨ï¼‰

### æ­¥é©Ÿ 3ï¼šå»ºç«‹ Storage Bucket

1. å‰å¾€ Supabase Dashboard â†’ Storage
2. é»æ“Šã€ŒNew bucketã€
3. è¨­å®šï¼š
   - **åç¨±**ï¼š`user-notes`
   - **Public bucket**ï¼šâŒ ä¸å‹¾é¸ï¼ˆç§æœ‰ï¼‰
   - **File size limit**ï¼š15MB
   - **Allowed MIME types**ï¼š`application/json`

### æ­¥é©Ÿ 4ï¼šåŸ·è¡Œ SQL è…³æœ¬

1. å‰å¾€ Supabase Dashboard â†’ SQL Editor
2. é»æ“Šã€ŒNew queryã€
3. è¤‡è£½ `supabase_setup.sql` çš„å®Œæ•´å…§å®¹
4. é»æ“Šã€ŒRunã€åŸ·è¡Œ

åŸ·è¡ŒæˆåŠŸå¾Œï¼Œæ‚¨æœƒçœ‹åˆ°ç¢ºèªè¨Šæ¯ï¼Œè¡¨ç¤ºå·²å»ºç«‹ï¼š
- Storage Bucket: `user-notes`
- è¡¨æ ¼: `admins`ï¼ˆç®¡ç†å“¡ï¼‰
- è¡¨æ ¼: `user_profiles`ï¼ˆç”¨æˆ¶è³‡æ–™ï¼Œå«å¯©æ ¸ç‹€æ…‹ï¼‰
- è¡¨æ ¼: `chat_messages`ï¼ˆç¾¤èŠï¼Œé ç•™ï¼‰
- è¡¨æ ¼: `private_messages`ï¼ˆç§è¨Šï¼Œé ç•™ï¼‰
- ç›¸é—œ RLS æ”¿ç­–å’Œè§¸ç™¼å™¨

### æ­¥é©Ÿ 5ï¼šé©—è­‰è¨­å®š

1. å‰å¾€ Database â†’ Tablesï¼Œç¢ºèªè¡¨æ ¼å·²å»ºç«‹
2. å‰å¾€ Storage â†’ Bucketsï¼Œç¢ºèª `user-notes` bucket å­˜åœ¨
3. å‰å¾€ Authentication â†’ Providersï¼Œç¢ºèª Google å·²å•Ÿç”¨

---

## æ¸¬è©¦æµç¨‹

### 1. ç®¡ç†å“¡ç™»å…¥æ¸¬è©¦

1. é–‹å•Ÿç¶²ç«™ `https://rnap.riotoolkit.cc`
2. é»æ“Šå³ä¸‹è§’é½’è¼ªåœ–ç¤º âš™ï¸
3. ä½¿ç”¨ç®¡ç†å“¡ Google å¸³è™Ÿç™»å…¥ï¼ˆ`terrywang981231@gmail.com` æˆ– `bob805606569@gmail.com`ï¼‰
4. ç¢ºèªç‹€æ…‹é¡¯ç¤ºã€Œå·²æ‰¹å‡†ã€ä¸”æœ‰ã€Œç®¡ç†å“¡å·¥å…·ã€å€å¡Š
5. é»æ“Šã€Œç”¨æˆ¶ç®¡ç†ã€ç¢ºèªç®¡ç†é¢æ¿æ­£å¸¸é¡¯ç¤º

### 2. é›²ç«¯åŒæ­¥æ¸¬è©¦

1. å»ºç«‹å¹¾å‰‡ç­†è¨˜
2. é»æ“Šã€Œä¸Šå‚³è‡³é›²ç«¯ã€
3. é–‹å•Ÿç„¡ç—•æ¨¡å¼æˆ–å…¶ä»–ç€è¦½å™¨
4. ä½¿ç”¨ç›¸åŒå¸³è™Ÿç™»å…¥
5. é»æ“Šã€Œå¾é›²ç«¯åˆä½µã€
6. ç¢ºèªç­†è¨˜æˆåŠŸåŒæ­¥

### 3. ä¸€èˆ¬ç”¨æˆ¶å¯©æ ¸æ¸¬è©¦

1. ä½¿ç”¨éç®¡ç†å“¡ Google å¸³è™Ÿç™»å…¥
2. ç¢ºèªç‹€æ…‹é¡¯ç¤ºã€Œç­‰å¾…å¯©æ ¸ã€
3. ç¢ºèªç„¡æ³•ä½¿ç”¨é›²ç«¯åŒæ­¥åŠŸèƒ½
4. ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥
5. é»æ“Šã€Œç”¨æˆ¶ç®¡ç†ã€â†’ã€Œå¾…å¯©æ ¸ã€
6. æ‰¾åˆ°è©²ç”¨æˆ¶ä¸¦é»æ“Šã€Œæ‰¹å‡†ã€
7. åˆ‡æ›å›ä¸€èˆ¬ç”¨æˆ¶ï¼Œé‡æ–°æ•´ç†é é¢
8. ç¢ºèªç¾åœ¨å¯ä»¥ä½¿ç”¨é›²ç«¯åŒæ­¥åŠŸèƒ½

### 4. è‡ªå‹•åŒæ­¥æ¸¬è©¦

1. ä»¥å·²æ‰¹å‡†ç”¨æˆ¶ç™»å…¥
2. é–‹å•Ÿã€Œè‡ªå‹•åŒæ­¥ã€é–‹é—œ
3. ç­‰å¾…è¨­å®šçš„é–“éš”æ™‚é–“ï¼ˆé è¨­ 5 åˆ†é˜ï¼‰
4. è§€å¯Ÿ Console ç¢ºèªè‡ªå‹•åŒæ­¥åŸ·è¡Œ

---

## å·²å»ºç«‹çš„è³‡æ–™åº«çµæ§‹

### user_profiles è¡¨

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | UUID | ä½¿ç”¨è€… IDï¼ˆé—œè¯ auth.usersï¼‰ |
| email | TEXT | é›»å­éƒµä»¶ |
| display_name | TEXT | é¡¯ç¤ºåç¨± |
| avatar_url | TEXT | é ­åƒ URL |
| status | ENUM | ç‹€æ…‹ï¼ˆpending/approved/rejected/bannedï¼‰ |
| storage_limit_bytes | BIGINT | å„²å­˜ç©ºé–“é™åˆ¶ï¼ˆé è¨­ 15MBï¼‰ |
| storage_used_bytes | BIGINT | å·²ä½¿ç”¨ç©ºé–“ |
| auto_sync_enabled | BOOLEAN | æ˜¯å¦å•Ÿç”¨è‡ªå‹•åŒæ­¥ |
| auto_sync_interval_minutes | INTEGER | è‡ªå‹•åŒæ­¥é–“éš”ï¼ˆåˆ†é˜ï¼‰ |
| last_seen_at | TIMESTAMPTZ | æœ€å¾Œä¸Šç·šæ™‚é–“ |
| created_at | TIMESTAMPTZ | å»ºç«‹æ™‚é–“ |

### admins è¡¨

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | UUID | ä¸»éµ |
| user_id | UUID | ä½¿ç”¨è€… ID |
| email | TEXT | é›»å­éƒµä»¶ï¼ˆå”¯ä¸€ï¼‰ |
| storage_limit_bytes | BIGINT | å„²å­˜ç©ºé–“é™åˆ¶ï¼ˆé è¨­ 100MBï¼‰ |
| notes | TEXT | å‚™è¨» |

---

## å¯ç”¨çš„ RPC å‡½æ•¸

| å‡½æ•¸åç¨± | æ¬Šé™ | èªªæ˜ |
|----------|------|------|
| `is_admin()` | æ‰€æœ‰ç”¨æˆ¶ | æª¢æŸ¥è‡ªå·±æ˜¯å¦ç‚ºç®¡ç†å“¡ |
| `is_user_approved()` | æ‰€æœ‰ç”¨æˆ¶ | æª¢æŸ¥è‡ªå·±æ˜¯å¦å·²æ‰¹å‡† |
| `get_my_profile()` | æ‰€æœ‰ç”¨æˆ¶ | å–å¾—è‡ªå·±çš„å®Œæ•´ profile |
| `get_storage_limit()` | æ‰€æœ‰ç”¨æˆ¶ | å–å¾—è‡ªå·±çš„å„²å­˜é™åˆ¶ |
| `update_my_settings()` | æ‰€æœ‰ç”¨æˆ¶ | æ›´æ–°è‡ªå‹•åŒæ­¥ç­‰è¨­å®š |
| `update_last_seen()` | æ‰€æœ‰ç”¨æˆ¶ | æ›´æ–°æœ€å¾Œä¸Šç·šæ™‚é–“ |
| `get_online_users()` | å·²æ‰¹å‡†ç”¨æˆ¶ | å–å¾—ç·šä¸Šç”¨æˆ¶åˆ—è¡¨ |
| `admin_get_pending_users()` | ç®¡ç†å“¡ | å–å¾—å¾…å¯©æ ¸ç”¨æˆ¶ |
| `admin_get_all_users()` | ç®¡ç†å“¡ | å–å¾—æ‰€æœ‰ç”¨æˆ¶ |
| `admin_approve_user()` | ç®¡ç†å“¡ | æ‰¹å‡†ç”¨æˆ¶ |
| `admin_reject_user()` | ç®¡ç†å“¡ | æ‹’çµ•ç”¨æˆ¶ |
| `admin_ban_user()` | ç®¡ç†å“¡ | ç¦ç”¨ç”¨æˆ¶ |
| `admin_set_user_storage_limit()` | ç®¡ç†å“¡ | è¨­å®šç”¨æˆ¶å„²å­˜é™åˆ¶ |

---

## å®‰å…¨æ€§èªªæ˜

1. **ç®¡ç†å“¡èº«ä»½ä¿è­·**ï¼šç®¡ç†å“¡éƒµç®±åªå„²å­˜åœ¨ `admins` è¡¨ä¸­ï¼Œä¸€èˆ¬ç”¨æˆ¶ç„¡æ³•æŸ¥è©¢
2. **RLS æ”¿ç­–**ï¼šæ‰€æœ‰è³‡æ–™è¡¨éƒ½å•Ÿç”¨ Row Level Security
3. **Storage æ¬Šé™**ï¼šåªæœ‰å·²æ‰¹å‡†çš„ç”¨æˆ¶æ‰èƒ½å­˜å– Storage
4. **PKCE æµç¨‹**ï¼šä½¿ç”¨ OAuth 2.0 PKCE æµç¨‹å¢å¼·å®‰å…¨æ€§

---

## æ•…éšœæ’é™¤

### å•é¡Œï¼šGoogle ç™»å…¥å¾Œç„¡æ³•è¿”å›ç¶²ç«™

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª Supabase çš„ Redirect URLs åŒ…å«ç¶²ç«™ç¶²å€
2. ç¢ºèª Google Cloud Console çš„é‡æ–°å°å‘ URI è¨­å®šæ­£ç¢º

### å•é¡Œï¼šç”¨æˆ¶ç‹€æ…‹ä¸€ç›´æ˜¯ pending

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª SQL è…³æœ¬å·²æ­£ç¢ºåŸ·è¡Œ
2. æª¢æŸ¥ `handle_new_user` è§¸ç™¼å™¨æ˜¯å¦å­˜åœ¨
3. å°æ–¼ç®¡ç†å“¡å¸³è™Ÿï¼Œç¢ºèª `admins` è¡¨ä¸­æœ‰è©²éƒµç®±è¨˜éŒ„

### å•é¡Œï¼šç„¡æ³•ä¸Šå‚³ç­†è¨˜

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªç”¨æˆ¶ç‹€æ…‹æ˜¯ `approved`
2. ç¢ºèª `user-notes` bucket å­˜åœ¨ä¸” RLS æ”¿ç­–æ­£ç¢º
3. æª¢æŸ¥ç­†è¨˜å¤§å°æ˜¯å¦è¶…éé™åˆ¶

### å•é¡Œï¼šè‡ªå‹•åŒæ­¥æ²’æœ‰åŸ·è¡Œ

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèªç”¨æˆ¶ç‹€æ…‹æ˜¯ `approved`
2. ç¢ºèªè‡ªå‹•åŒæ­¥å·²é–‹å•Ÿ
3. æª¢æŸ¥ç€è¦½å™¨ Console æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯

---

## ç›¸é—œæª”æ¡ˆ

| æª”æ¡ˆ | èªªæ˜ |
|------|------|
| `static/js/supabase_auth.js` | Supabase èªè­‰èˆ‡é›²ç«¯åŒæ­¥æ¨¡çµ„ |
| `static/css/main.css` | åŒ…å«èªè­‰ç›¸é—œ UI æ¨£å¼ |
| `supabase_setup.sql` | è³‡æ–™åº«åˆå§‹åŒ– SQL è…³æœ¬ |
| `index.html` | è¼‰å…¥ supabase_auth.js |

---

## æœªä¾†åŠŸèƒ½ï¼ˆå·²é ç•™ï¼‰

ä»¥ä¸‹åŠŸèƒ½çš„è³‡æ–™åº«çµæ§‹å·²åœ¨ SQL è…³æœ¬ä¸­é ç•™ï¼š

1. **ç¾¤èŠåŠŸèƒ½**ï¼š`chat_messages` è¡¨å·²å»ºç«‹ï¼Œæ”¯æ´ Realtime
2. **ç§è¨ŠåŠŸèƒ½**ï¼š`private_messages` è¡¨å·²å»ºç«‹ï¼ŒåŒ…å« 1 å¤©éæœŸæ©Ÿåˆ¶
3. **Web Push**ï¼š`push_notifications_enabled` æ¬„ä½å·²é ç•™

é€™äº›åŠŸèƒ½çš„å‰ç«¯å¯¦ç¾å°‡åœ¨å¾ŒçºŒç‰ˆæœ¬ä¸­å®Œæˆã€‚
